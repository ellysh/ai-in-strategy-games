## 3.1 Теория игр и шахматы

### 3.1.1 Классификация игры

Для начала определим, к какому классу стратегических игр относятся [шахматы](https://ru.wikipedia.org/wiki/Шахматы). Для этого обратимся к таблице 1-1 и пройдём по каждому признаку.

Начнём с первого признака, который зависит от порядка ходов. В шахматах участники ходят по очереди друг за другом. Поэтому шахматы — это последовательная игра.

Выигрыш одного игрока означает поражение другого. По правилам шахматных турниров выигравший партию игрок получает одно очко, а проигравший — ноль. В партии возможна ничья. При этом игроки делят выигрыш пополам: каждый получает по 0.5 очков. Из этих правил следует, что шахматы — это игра с нулевой суммой.

В шахматах правила игры являются общим знанием. Каждый участник знает правила игры, выигрыши при возможных исходах и функции полезности. Игроки в некоторой степени знают стратегии друг друга потому, что могут просчитать несколько ходов наперёд. Таким образом шахматы — это игра с полной информацией.

Во время шахматной партии участники могут записывать или запоминать все выполненные ходы. Это устраняет стратегическую неопределённость. Следовательно, шахматы относятся к играм с совершенной информацией.

В шахматах нет элемента случайности. Никакое случайное событие не может повлиять на исход партии. Когда нет внешней неопределённости, игроки могут просчитывать будущие ходы. Поэтому шахматы относятся к детерминированным играм.

Во время турнира одни и те же игроки часто играют друг с другом несколько раз. При этом во время партии каждый из них делает несколько ходов. Поэтому шахматы — это многократная и многоходовая игра.

Правила игры фиксированные. На турнирах каждому игроку отводится определённое время на все ходы. Количество времени зависит от типа турнира:

* **Классический**. На первые 40 ходов каждому игроку отводится 90 минут. После 40-ого хода каждому игроку добавляется 30 минут. К этим 30 минутам добавляется по 30 секунд за каждый ход, сделанный с начала партии.

* **Рапид** (rapid). Каждому игроку отводится от 10 до 60 минут на все ходы.

* **Блиц** (blitz). Игрокам отводится от 3 до 10 минут на ходы.

* **Буллит** (bullet). Игроки имеют менее 3-х минут на ходы.

* **Армагеддон** (armageddon). Игрок за чёрные фигуры выигрывает в случае ничьей. Ему отводится на 1 минуту меньше времени, чем игроку за белые фигуры. Обычно, белые имеют 6 или 5 минут на все ходы. Соответственно чёрные имеют 5 или 4 минуты.

Шахматы — это игра с нулевой суммой для двух участников. Поэтому игроки не могут договориться о совместных действиях. Это означает, что игра некооперативная. Единственный вид договорённости в шахматах: когда один из участников предлагает ничью, а другой на неё соглашается.

Во время партии каждый игрок имеет право ходить только своими фигурами. Поэтому шахматы относятся к пристрастным играм.

Шахматная доска имеет 64 клетки. В начале игры каждый участник имеет по 16 фигур. В течении партии число фигур на доске уменьшается. Это значит, что число возможных позиций фигур на доске конечно. Из этого следует, что число стратегий у каждого игрока тоже конечное. Таким образом шахматы — это дискретная игра.

Подведём итог. С точки зрения теории игр шахматы — это игра:

* Последовательная
* С нулевой суммой
* С полной информацией
* С совершенной информацией
* Детерминированная
* Многократная и многоходовая
* С фиксированными правилами
* Некооперативная
* Пристрастная
* Дискретная

### 3.1.2 Решение игры

Посмотрим, что говорит теория игр о решении шахмат. Сможет ли теория ответить на вопрос: какая стратегия для игроков наилучшая?

Мы уже знаем, что последовательную игру удобнее представлять в развёрнутой форме. Для этого надо построить дерево игры. В случае шахмат, каждый узел дерева представляет собой некоторую позицию фигур на доске. Ветви исходящие из узла соответствуют ходам, допустимым в данной позиции. Ветви входящие в узел означают ходы, которые приводят к данной позиции. 

Исходная позиция фигур на доске будет начальным узлом дерева. Эту позицию демонстрирует иллюстрация 3-1.

{caption: "Иллюстрация 3-1. Начальная позиция фигур на шахматной доске", height: "40%"}
![Начальная позиция](images/Chess/chess-initial-position.png)

В теории построить дерево игры возможно, поскольку в шахматной партии конечное число ходов. Получив такое дерево, мы можем применить метод обратной индукции и найти решение игры.

Первым ходит игрок с белыми фигурами. У него есть 20 возможных ходов из начальной позиции. Каждая из восьми пешек может перейти вперед на одну или две клетки. Это даст 16 ходов. Каждый из двух коней может пойти буквой Г направо или налево. Это ещё 4 потенциальных хода. В сумме получается 20. Поэтому из начального узла дерева игры исходит 20 ветвей.

Каждая из 20 ветвей заканчивается узлом действия. В этом узле ходит игрок с чёрными фигурами. У него есть 20 первых ходов, которые аналогичны белым: пешками и конями. Следовательно, из каждого узла действия исходит ещё 20 ветвей.

После двух ходов игроков мы получили 400 узлов действия. На третьем ходу у белых есть 26 возможных ходов. На каждый из них чёрные отвечают своими 26-ю ходами. Это значит, что к четвёртом ходу дерево решений имеет в сумме 270400 узлов действия.

Число узлов в дереве решений с каждым ходом стремительно растёт. Каким же будет его размер к концу партии? Этим вопросом заинтересовался американский математик [Клод Шеннон](https://ru.wikipedia.org/wiki/Шеннон,_Клод). В 1950 году он [оценил](https://ru.wikipedia.org/wiki/Число_Шеннона) сложность игры в шахматы. Согласно его расчётам, число возможных позиций фигур на шахматной доске примерно равно 10^44^. Это позиции, которые допустимы с точки зрения правил игры. При этом [**сложность дерева игры**](https://en.wikipedia.org/wiki/Game_complexity#Game-tree_complexity) составляет примерно 10^120^. Эта сложность означает суммарное число узлов в дереве игры от начала до конца обычной партии.

Из-за огромного размера дерева игры в шахматы его нельзя построить и проанализировать на практике. Не существует компьютера с достаточной памятью, чтобы сохранить все узлы дерева. Кроме того чтобы пройти по этим узлам, самому мощному современному компьютеру понадобится около 10^100^ лет.

Мы пришли к такому выводу: инструменты теории игр могут решить шахматы. Однако, для этого у нас недостаточно ресурсов.

Оптимальная стратегия в шахматах никому неизвестна. Но это не мешает профессиональным игрокам находить лучшие ходы и выигрывать партии. Как им это удаётся?

### 3.1.3 Стратегии поиска лучшего хода

В 1950 году Клод Шеннон опубликовал статью "Программирование компьютера для игры в шахматы" ("Programming a Computer for Playing Chess"). В ней он предложил возможные стратегии для поиска лучшего хода в дереве игры. Алгоритм поиска начинает свою работу в начальном узле дерева игры. Он оценивает возможные ходы, которые допустимы в текущей позиции. Для такой оценки алгоритм проходит вглубь дерева, чтобы узнать последствия рассматриваемого хода.

Клод Шеннон предложил две стратегии:

* [Типа A](https://www.chessprogramming.org/Type_A_Strategy)

* [Типа Б](https://www.chessprogramming.org/Type_B_Strategy)

### 3.1.3.1 Стратегия типа А

В стратегии типа А шахматная программа оценивает каждый возможный ход с помощью эвристической функции. Эта функция присваивает каждой позиции числовое значение в зависимости от того, насколько она выгодна для программы. Такое значение называется **статической оценкой позиции**. Среди всех возможных ходов программа выбирает тот, который ведёт к позиции с наивысшей статической оценкой. Именно этот ход считается лучшим.

Реальный алгоритм поиска может исследовать только ограниченное число узлов за отведённое ему время. Поэтому чтобы сделать процесс оценки позиций более эффективным, необходимы некоторые упрощающие предположения. Прежде всего считается, что противник всегда будет отвечать наилучшим возможным ходом. Только этот ответ будет рассматривать алгоритм поиска.

Второе предположение касается глубины поиска. Чтобы стратегия типа А работала эффективно, глубина дерева на которую проходит алгоритм для оценки каждого хода искусственно ограничивается. Другими словами алгоритм просчитывает ходы не до конца партии, а только, например, следующие четыре. Тогда наилучшим будет считаться тот ход, который через четыре хода приведёт к лучшей позиции.

Стратегия поиска типа А относительна проста. Тем не менее именно на ней основаны почти все сильнейшие современные шахматные программы. В них используются разного рода эвристики и оптимизации. Но несмотря на эти усовершенствования в основе программ лежит стратегия типа А Клода Шеннона.

### 3.1.3.2 Стратегия типа Б

В стратегии типа Б шахматная программа также оценивает каждый возможный ход. Но для этого она рассматривает ряд гипотетических позиций на доске, которые могли бы возникнуть, если бы этот ход был сыгран. Каждую из этих гипотетических позиций программа оценивает с помощью той же эвристической функции, что и в стратегии типа А. Из всех возможных ходов выбирается тот, который ведёт к позиции с наилучшей оценкой.

Основное преимущество стратегии типа Б в том, что она учитывает больше вариантов развития событий. Стратегия типа А рассматривает только наилучший ответ оппонента на каждый возможный ход. В отличие от неё стратегия типа Б рассматривает все возможные ответы. Таким образом она может найти варианты шахматных комбинаций, которые упускает из виду стратегия типа А.

На практике стратегия типа Б оказывается дороже в плане вычислений. Причина в том, что программа для каждого своего возможного хода должна оценивать больше ответных ходов оппонента и вытекающих из них позиций. Кроме этого стратегия очень чувствительна к качеству эвристической функции. Если функция учитывает недостаточно факторов позиции, шахматная программа будет выбирать слабые ходы.

Ещё одна серьёзная проблема стратегии типа Б — **застревание в локальных максимумах**. Её причина в том, что алгоритм рассматривает гипотетические позиции после одного хода. Другими словами программа исследует дерево игры только на один шаг вперёд от текущей позиции. Из-за этого она может упустить лучшие ходы, для достижения которых требуется более длинная последовательность действий.

Рассмотрим проблему застревания в локальном максимуме на примере. Предположим, что алгоритм поиска рассматривает два возможных хода: X и Y. Ход X приводит к позиции, в которой программа получает небольшое преимущество. После хода Y программа получает немного худшее положение. Но Y начинает последовательность ходов, которая в конечном итоге приводит к гораздо лучшей позиции, чем после X.

Стратегия поиска типа Б упускает из виду потенциал хода Y. Она оценивает только гипотетическую позицию сразу после хода Y, а она хуже чем после X. Поэтому алгоритм приходит к ошибочному выводу, что ход X — лучший в данной позиции.

Некоторые разработчики шахматных компьютеров и программ пробовали применить стратегию типа Б. Это происходило на заре развития компьютерной техники. Вычислительная мощность оборудования того времени была очень ограничена. Её не хватало для эффективной реализации такого сложного алгоритма. Кроме того проблема с застреванием в локальных максимумах приводила к слабой игре.

Со временем стратегия типа Б стала пользоваться дурной репутацией среди разработчиков и её перестали применять.

### 3.1.3.3 Стратегия типа Б*

В 1970-х годах заслуженный эксперт по шахматным программам Ханс Берлинер из университета Карнеги — Меллона предложил модифицированную версию стратегии типа Б Клода Шеннона под названием Б*.

Основная идея новой стратегии в том, чтобы устранить главные ограничения исходного подхода типа Б: высокую вычислительную стоимость и застревание в лоакальных максимумах.

Для этого в алгоритме Б* используется комбинация стратегий типов Б и А. Идея в том, чтобы искать перспективные ходы более быстрой стратегией типа А. Далее с помощью стратегии типа Б анализировать найденные ходы.

Кроме комбинации стратегий типов Б и А, алгоритм Б* включает другие оптимизации:

1. Метод итеративного углубления.

2. Таблицы транспозиций.

Мы уже рассмотрели поиск с **итеративным углублением**, когда знакомились с классическим поиском. Применительно к шахматам, он также выполняет несколько итераций с увеличением макисмальной глубины.

Его идея состоит в том, чтобы начать обход дерева игры с небольшой глубины. На этой глубине алгоритм находит лучший ход. Затем он запускает следующую итерацию поиска с увеличенным ограничением глубины, чтобы более щательно оценить найденный лучший ход. Итерации с увеличением глубины поиска повторяются пока не будет достигнут установленный предел времени или предел глубины.

Метод итеративного углубления ускоряет алгоритм поиска. При этом сохраняется качество оценки перспективных ходов.

**Таблица транспозиций** — это структура данных, в которой хранятся ранее найденные позиции и результаты оценочной функции для них. Когда алгоритм поиска встречает позицию, для которой уже выполнялась оценочная функция, он использует сохранённый результат из таблицы траспозиций. Такой подход позволяет алгоритму быстро удалять ветви поиска, которые ведут к худшим ходам.

Таблица транспозиций также повышает скорость поиска и предотвращает многократную оценку одних и тех же позиций.

Ханс Берлинер применил свой алгоритм в созданном им шахматном компьютере HiTech. Он показывал хорошие результаты на турнирах. Позже некоторые идеи поиска Б* переняли более продвинутые шахматные компьютеры и программы.

{pagebreak}
