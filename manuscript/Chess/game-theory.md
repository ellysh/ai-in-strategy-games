## 3.1 Теория игр и шахматы

Наш разговор о шахматах начнём с теории игр. Выясним, что теория может рассказать нам об этой игре.

### 3.1.1 Классификация игры

Чтобы применить аппарат теории игр для поиска решения, надо выяснить, к какому классу относится рассматриваемая игра. Для этого обратимся к таблице 1-1 и пройдём по каждому признаку.

Первый признак определяет порядок ходов. В шахматах участники ходят по очереди друг за другом. Поэтому шахматы — это последовательная игра.

Выигрыш одного игрока означает поражение другого. По правилам шахматных турниров выигравший партию игрок получает одно очко, а проигравший — ноль. В партии возможна ничья. Тогда игроки делят выигрыш пополам: каждый получает по 0.5 очков. Из этих правил следует, что шахматы — это игра с нулевой суммой.

Шахматные правила являются общим знанием. Каждый участник знает правила игры, выигрыши при возможных исходах и функции полезности. Игроки в некоторой степени знают стратегии друг друга, поскольку просчитывают на несколько ходов вперёд. Таким образом шахматы — это игра с полной информацией.

Во время шахматной партии участники могут запоминать или записывать все сыгранные ходы. Таким образом каждый из них знает все игровые события на момент своего хода. Стратегической неопределённости нет, поэтому шахматы — это игра с совершенной информацией.

В шахматах нет элемента случайности. Никакое случайное событие не может повлиять на ход партии. Когда нет внешней неопределённости, игроки могут просчитать будущие ходы. Поэтому шахматы относятся к детерминированным играм.

Во время турниров и матчей одни и те же игроки встречаются за доской несколько раз. Во время одной партии каждый участник делает несколько ходов. Поэтому шахматы — это многократная и многоходовая игра.

Правила игры фиксированные. На турнирах каждому игроку отводится определённое время на все ходы. Количество времени зависит от типа турнира:

* **Классический**. На первые 40 ходов каждому игроку отводится 90 минут. После 40-ого хода каждому игроку добавляется 30 минут. К этим 30 минутам добавляется по 30 секунд за каждый ход, сделанный с начала партии.

* **Рапид** (rapid). Каждому игроку отводится от 10 до 60 минут на все ходы.

* **Блиц** (blitz). Игрокам отводится от 3 до 10 минут на ходы.

* **Буллит** (bullet). Игроки имеют менее 3-х минут на ходы.

* **Армагеддон** (armageddon). Игрок за чёрные фигуры выигрывает в случае ничьей. Ему отводится на 1 минуту меньше времени, чем игроку за белые фигуры. Обычно, белые имеют 6 или 5 минут на все ходы. Соответственно чёрные имеют 5 или 4 минуты.

Шахматы — это игра с нулевой суммой для двух участников. Поэтому игроки не могут договориться о совместных действиях. Это означает, что игра некооперативная. Единственная возможная договорённость в шахматах: когда один участник предлагает ничью, а другой на неё соглашается.

Во время партии каждый игрок ходит только своими фигурами. То есть у каждого участника свой набор возможных ходов. Поэтому шахматы относятся к пристрастным играм.

Шахматная доска имеет 64 клетки. В начале игры каждый участник имеет по 16 фигур. В течении партии число фигур на доске уменьшается. Из этого следует, что число возможных позиций фигур на доске конечно. Тогда число стратегий у каждого игрока тоже конечное. Поэтому шахматы — это дискретная игра.

Подведём итог. С точки зрения теории игр шахматы — это игра:

* Последовательная
* С нулевой суммой
* С полной информацией
* С совершенной информацией
* Детерминированная
* Многократная и многоходовая
* С фиксированными правилами
* Некооперативная
* Пристрастная
* Дискретная

### 3.1.2 Решение игры

Посмотрим, что говорит теория игр о решении шахмат. Сможет ли она найти лучшую стратегию для игроков?

Мы уже знаем, что последовательную игру удобнее представлять в развёрнутой форме. Для этого надо построить дерево игры. В случае шахмат, каждый узел дерева соответствует некоторой позиции фигур на доске. Исходящие из узла ветви соответствуют ходам, допустимым в данной позиции. Входящие в узел ветви означают ходы, которые к ней приводят. Начальным узлом дерева будет исходная позиция фигур на доске. Её демонстрирует иллюстрация 3-1.

{caption: "Иллюстрация 3-1. Исходная позиция фигур на шахматной доске", height: "40%"}
![Исходная позиция](images/Chess/chess-initial-position.png)

Шахматны — это дискретная игра. Число игровых состояний и ходов каждого участника в ней конечно. Поэтому для шахмат теоретически возможно построить дерево игры. Далее следует применить метод обратной индукции. Так мы рассмотрим все ходы, начиная с каждого возможного окончания партии. Изучив все окончания, мы найдём решение игры.

Рассмотрим, как обстоит дело на практике. Первым ходит игрок с белыми фигурами. Каждая из его восьми пешек может пойти вперёд на одну или две клетки. Это даст 16 ходов. Каждый из двух коней может пойти буквой Г направо или налево. Это ещё 4 потенциальных хода. В сумме получается 20 возможных ходов белых в исходной позиции. Поэтому из начального узла дерева игры исходит 20 ветвей.

Каждая из 20 ветвей заканчивается узлом действия. В этом узле ходит игрок с чёрными фигурами. У него есть 20 первых ходов, которые аналогичны белым: 16 пешками и 4 конями. Следовательно, из каждого узла действия исходит ещё 20 ветвей.

После двух ходов игроков мы получили `20 * 20 = 400` узлов действия. На третьем ходу у белых есть 26 возможных ходов. На каждый из них чёрные отвечают своими 26-ю ходами. Поэтому к четвёртом ходу дерево игры имеет в сумме `20 * 20 * 26 * 26 = 270400` узлов действия.

Число узлов в дереве игры с каждым ходом стремительно растёт. Каким же будет его размер к концу партии? Этим вопросом заинтересовался американский математик [Клод Шеннон](https://ru.wikipedia.org/wiki/Шеннон,_Клод). В 1950 году он опубликовал статью "Программирование компьютера для игры в шахматы" ("Programming a Computer for Playing Chess"). В ней учёный даёт следующие оценки:

* В типичной шахматной позиции в среднем есть 30 ходов, допустимых правилами.

* Если в типичной шахматной позиции ходят белые, а затем чёрные, получается примерно 10^3^ комбинаций двух ходов.

* Типичная шахматная партия длится в среднем 40 ходов.

* От начала до конца типичной шахматной партии есть порядка 10^120^ возможных ходов.

Число 10^120^ получило название [**число Шеннона**](https://ru.wikipedia.org/wiki/Число_Шеннона). Оно означает нижнюю границу сложности дерева игры в шахматы. [**Сложность дерева игры**](https://en.wikipedia.org/wiki/Game_complexity#Game-tree_complexity) (game tree complexity) — это общее количество возможных состояний, которые могут возникнуть в игре при рассмотрении всех возможных ходов игроков из начальной позиции.

Число Шеннона неоднократно уточнялось. Последние исследования говорят о том, что сложность дерева игры в шахматы составляет порядка 10^40^. Эта оценка учитывает только "разумные" ходы. То есть те, которые не являются очевидно проигрышными. Пример такого проигрышного хода — перемещение ферзя на поле, которое бьёт пешка противника без какой-либо компенсации.

Возьмём оптимистичную оценку сложности дерева игры 10^40^. Современная шахматная программа просчитывает от 10 до 100 миллионов позиций на обычном процессоре (CPU). Тогда даже в лучшем случае для просчёта всего дерева игры ей понадобится столько секунд:

10^40^ / 10^8^ = 10^32^

Это равно примерно 10^24^ лет.

Мы пришли к такому выводу: теория игр даёт работающий алгоритм, чтобы найти решение шахмат. Но чтобы его выполнить за разумное время, у нас недостаточно вычислительных ресурсов.

Означает ли это, что теория игр бесполезна для шахмат? Вовсе нет. Клод Шеннон пробовал применить теорию для разработки шахматных программ. Познакомимся с результатами его работы.

### 3.1.3 Стратегия типа A

В статье ""Программирование компьютера для игры в шахматы"" Клод Шеннон рассуждает о способах создания шахматной программы. В качестве отправной точки он берёт теорему о минимаксе. В 1928 году Джон фон Нейман описал в общих чертах, как применить эту теорему для игр с нулевой суммой и двумя участниками. Клод Шеннон впервые описал алгоритм шахматной программы, построенной на теореме минимакса.

Ключевую роль в алгоритме Шеннона играет функция оценки f(P) текущей позиции P. Учёный признаёт, что функция f(P) для шахмат очень сложна. Есть игры (например, [**ним**](https://ru.wikipedia.org/wiki/Ним_(игра))) с простой функцией оценки. В таких случаях её можно точно описать. Если компьютерная программа станет выбирать ходы, ориентируясь на точную функцию оценки, она будет идеальным игроком. **Идеальный игрок** (perfect player) всегда выбирает стратегию, которая приводит к наилучшему возможному результату.

Клод Шеннон предлагает ориентироваться на приближённую функцию оценки шахматной позиции. Её можно составить, опираясь на шахматную теорию. Учёный приводит следующие принципы этой теории в качестве примера:

1. Относительная ценность фигур в пешках. Например, ферзь равен девяти пешкам, а ладья — пяти.

2. Ладьи следует размещать на открытых вертикалях.

3. Отсталые, изолированные и сдвоенные пешки слабы.

4. Открытый король — это слабость в середине и начале партии.

Это неполный список. Клод Шеннон предлагает его продолжить. Учёный утверждает, что принципов шахматной теории будет достаточно для приближённой функции оценки позиции.

У функции оценки есть серьёзный недостаток. Её можно применять только в спокойных позициях. **Спокойная позиция** — это та в которой нет хода, резко меняющего соотношение сил на доске. Пример такого хода — взятие фигуры. Если идёт серия разменов или разыгрывается комбинация, на результат функции оценки полагаться нельзя.

Несмотря на недостаток функции оценки, Клод Шеннон предложил вычислять с её помощью потенциальные выигрыши. Тогда для поиска лучшего хода можно применить алгоритм минимакс. Алгоритм должен работать с неявным деревом игры. Он развёртывает узлы дерева в процессе работы.

Полный алгоритм работы шахматной программы выглядит следующим образом:

1. **Сгенерировать свои ходы**. Для текущей позиции P программа развёртывает дочерние узлы. Так она получает список своих возможных ходов для дальнейшей проверки.

2. **Сгенерировать ответы оппонента**. Для каждого своего возможного хода, повторить операцию развёртывания. Так программа получает список возможных ответов оппонента.

3. **Повторить шаги 1 и 2**, пока не будет построено поддерево игры заданной глубины анализа. **Глубина анализа** — это число ходов, которые программа просчитывает наперёд для выбора своего хода.

4. **Применить функцию оценки** для каждого узла построенного поддерева. Так программа получает числовую оценку для каждой позиции. Чем выше оценка, тем лучше позиция для программы.

5. **Выбрать лучший ход в текущей позиции P**. Программа применяет метод обратной индукции и алгоритм минимакс. Она рассматривает ходы в обратном порядке, начиная с самого последнего в поддереве игры. Если рассматриваемый ход делает программа, она должна максимизировать значение функции оценки. Если ход оппонента, он должен минимизировать функцию оценки. Так программа выбирает свой ход с наилучшим результатом в построенном поддереве игры.

Клод Шеннон назвал такой поиск лучшего хода **стратегией типа A**. Учёный указывает на главное достоинство этой стратегии — простота реализации. В то же время он признаёт её следующие недостатки:

1. **Высокая временная сложность**. Это недостаток алгоритма минимакс, на котором строится стратегия типа A. Из-за него глубина анализа оказывается небольшой (порядка 4 ходов) даже на мощном современном компьютере.

2. **Неточность функции оценки позиции**. В шахматах есть стратегические нюансы позиции, которые проявляются через много ходов или только в конце партии. Функция оценки недостаточно чувствительна, чтобы учесть эти долгосрочные перспективы. Поэтому анализ на большую глубину не всегда повышает качество найденного лучшего хода.

3. **Отсутствие избирательности**. Стратегия типа A следует методу грубой силы. **Метод грубой силы** (brute force) означает полный перебор всех возможных вариантов. В результате программа не различает потенциально хорошие ходы и заведомо бесперспективные. Поэтому она тратит ресурсы на просчёт в глубину очевидно плохих ходов.

4. **Выбор хода в условиях ограниченного времени**. Стратегия типа А не учитывает ограничение по времени, которое есть в турнирных шахматных партиях. Если отведённое время заканчивается, а программа ещё не закончила полный проход по поддереву, она может выбрать очень плохой ход.

Чтобы скомпенсировать эти недостатки, Клод Шеннон предложил ряд улучшений. Они направлены на улучшение функции оценки и уменьшение вычислительной сложности алгоритма минимакс.

### 3.1.4 Стратегия типа B

Клод Шеннон оценил возможности стратегии типа A. Он пришёл к выводу, что компьютер 1950-х годов сможет просчитывать позиции максимум на 3 хода вперёд. Для качественной игры этого недостаточно. Поэтому учёный предложил ряд улучшений для своей стратегии.

Клод Шеннон рассуждает о том, как играют в шахматы люди. Профессиональный шахматист может просчитывать позиции на глубину до 15 ходов. Но он делает это только для нескольких самых перспективных ходов. Остальные посредственные ходы шахматист отбрасывает без просчёта. Это важное отличие игры человека от программы, следующей стратегии типа A.

Клод Шеннон предлагает следующие улучшения для стратегии типа A:

1. Программа должна просчитывать форсированные ходы как можно глубже. Только когда позиция становится спокойной, можно применять функцию оценки.

2. Нужен специальный алгоритм или процесс для отбора самых перспективных ходов. Программа должна просчитывать вглубь только их и отбрасывать очевидно плохие варианты без какой-либо дополнительной проверки.

I> **Форсированным ходом** называется реакция на угрозу или действие противника. Например, защита от шаха.

Клод Шеннон называет стратегию с этими двумя улучшениями **стратегией типа B**. Он утверждает, что использующая её программа сможет играть на высоком уровне. При этом она будет выбирать ходы с той же скоростью, что и человек.

Статья Клода Шеннона заложила фундамент для разработки шахматных программ. Исследователи стали экспериментировать с двумя предложенными стратегиями. Достаточно скоро они обнаружили следующие недостатки стратегии типа B:

1. **Ненадёжность эвристики для выбора перспективных ходов**. Разработать точную эвристику сложно, потому что она должна учитывать множество критериев. Приближенные эвристики оказываются ненадёжными и часто отбрасывают лучшие ходы.

2. **Накладные расходы при выполнении эвристики выбора перспективных ходов**. Если эвристика сложна, на её выполнение требуется дополнительное время. Тогда его остаётся меньше на просчёт в глубину отобранных перспективных ходов.

3. **Сложный компромисс при отсечении узлов дерева**. Могут быть две крайние стратегии отсечения: отсекать максимум узлов или минимум. Первая отбрасывает, в том числе и лучшие ходы. Вторая недостаточно снижает временную сложность по сравнению со стратегией типа A.

4. **Неточность функции оценки позиции**. Эта проблема стратегии типа A осталась нерешенной в стратегии типа B.

5. **Сложность реализации**. Эвристику выбора перспективных ходов реализовать сложнее, чем функцию оценки. Поэтому в ней часто встречаются ошибками, которые сильно снижают качество отбора ходов.

Главная проблема стратегии типа A — это вычислительная сложность. Она решается увеличением мощности компьютера. Недостатки стратегии типа B скомпенсировать значительно сложнее. Это привело к тому, что большинство разработчиков шахматных программ отдавало предпочтение стратегии типа A. Такие программы показывали лучшие результаты на турнирах.

### 3.1.5 Вклад теории игр в шахматы

Мы познакомились с одной из самых значительных работ по применению теории игр к шахматам. Теперь поговорим о практическом вкладе теории в шахматную игру.

Идеи Клода Шеннона оказали огромное влияние на разработку шахматных программ. Кроме этого на методе обратной индукции строятся программы, которые полностью просчитывают окончания партий с небольшим количеством фигур. Это вклад в шахматную теорию. Но как насчёт практики?

В реальных турнирных партиях шахматисты никогда не применяют математический аппарат теории игр. На это есть несколько причин:

1. Точные алгоритмы теории игр требуют большого объёма вычислений. Человеку нужно слишком много времени, чтобы применить алгоритм минимакс и его производные (например альфа-бета отсечение) в сложной шахматной позиции.

2. Оценка шахматной позиции — сложный процесс. Помимо материального баланса она включает такие факторы как активность фигур, пешечная структура, контроль ключевых полей и т.д. Эти факторы надо перевести в численные показатели, чтобы учесть в модели теории игр. Но сделать это чрезвычайно сложно.

3. Динамический характер игры. Ценность определённых фигур и позиций резко меняется в ходе игры. Это затрудняет применение алгоритмов теории игр.

4. Психологические аспекты игры. Турнирная шахматная партия включает такие элементы, как психологическая борьба, блеф, игру на эмоциях и ожиданиях противника. Эти аспекты трудно измерить и учесть в рамках теории игр.

5. Игроки часто полагаются на интуицию в сложных позициях, когда просчёт всех вариантов невозможен. Теория игр полностью игнорирует этот естественный для человека способ принятия решений. Она полагается только на точные расчёты и рациональность.

Получается, что теория игр многое дала шахматным программам. Но её вклад в профессиональные шахматы оказался очень ограниченным.

{pagebreak}
