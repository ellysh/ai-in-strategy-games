## 3.6 Человек против шахматных программ

Современные шахматные движки не оставляют никаких шансов лучшим шахматистам. Серьёзные матчи с призовым фондом между человеком и машиной перестали проводиться с 2006 года. Публика потеряла к ним интерес, из-за безусловного превосходства машины.

Ведущие шахматисты единогласно признают, что человек уже давно не может конкурировать с машиной. На этом разговор о подобном противостоянии можно было бы закончить. Однако, не будем торопиться. История противостояния человека и машины может тем не менее оказаться полезна. Из неё можно извлечь некоторый опыт и сделать определённые выводы.

### 3.6.1 Поиск ошибок

Противостояние человека и машины в шахматах обычно рассматривается с точки зрения профессиональных игроков и комментаторов. Шахматисты — эксперты в предметной области и кому как не им знать о тонкостях игры и правильной подготовке к сопернику? Это совершенно верная точка зрения.

С другой стороны, шахматные движки — это не только сильные игроки. В первую очередь это компьютерные программы, которые разрабатывают людьми. Давайте попробуем сместить наш фокус и поговорим о программах. Посмотрим, куда заведёт нас эта точка зрения.

Противостояние против программы в любой игре — скучное занятие. Те, кто играл в компьютерные игры против электронного оппонента, знают верный подход. Для победы достаточно найти хотя бы одну логическую ошибку в программе. Например, в какой-то игровой ситуации электронный оппонент принимает неверное решение и это даёт вам преимущество. Как только вы нашли эту слабость, противостояние превращается в рутину. Каждый раз вы создаёте нужную игровую ситуацию. Каждый раз попав в неё, оппонент реагирует неадекватно. Каждый раз вы выигрываете.

Этот трюк не сработает не только с человеком, но даже с животным. Всё дело в том, что программа, в отличие от людей, ничему не учится. Она не запоминает прошлые партии и не делает из них выводов. Её код написан и сохранён на жёстком диске. Каждый раз вы запускаете один и тот же код и он ведёт себя одинаково. В этом суть компьютерных программ.

I> Сейчас для простоты мы не рассматриваем спорадические ошибки программ, которые приводят к их неправильному поведению или аварийному завершению.

Программы пишут люди и люди ошибаются. Они делают неверные предположения, они торопятся из-за поджимающих сроков, они устают и хотят выходных после недели ежедневных переработок. Вот лишь несколько примеров условий, в которых разработчику программы очень легко допустить ошибку.

Есть отдельная категория профессиональных ИТ специалистов, которые целенаправленно ищут ошибки в программах, чтобы извлеч из них выгоды. Благодаря [Голливуду](https://ru.wikipedia.org/wiki/Хакеры_(фильм)) и масс-медиа, за ними закрепился термин "хакер". Задумайтесь — есть целая развитая индустрия, которая построена вокруг поиска ошибок в программах. Каждый день она становится всё крупнее, но о ней мало говорят из-за непопулярности темы. Это ещё раз доказывает, что ошибки есть везде: и в вашем автомобиле, и в программе управления вашим банковским счётом. Вопрос только в том, сколько времени и сил кто-то готов потратить, чтобы их найти.

Вернёмся к шахматам. Разработчики программ прекрасно понимают пагубное влияние логических ошибок на игровой процесс. Поэтому историю развития шахматных движков можно рассмотреть с позиции совершенствования средств поиска в них ошибок.

### 3.6.1.1 Ручной несистематический поиск

Разработчики самых первых шахматных программ следовали одной и той же стратегии тестирования. Этот подход начался с самой первой полноценной программы Бернштейна 1957 года.

Суть стратегии заключается в многократной игре против шахматной программы. Первые такие игры обычно проводит сам автор. Такой тест в терминах разработки ПО называется [**альфа-тестированием**](https://ru.wikipedia.org/wiki/Тестирование_программного_обеспечения#Уровни_тестирования). Выполняя его, разработчик обнаруживает элементарные логически ошибки оценочной функции и алгоритмические ошибки поиска. Пример — программа не делает рокировку в позиции, когда должна её делать.

После исправления элементарных ошибок наступает вторая стадия тестирования. Разработчик обращается к одному или нескольким сильным шахматистам, которые соглашаются принять участие в проекте. Обычно это профессиональный игрок с хорошим турнирным опытом. Они проводят серию игр против программы и указывают на обнаруженные в ней слабости. Этот процесс называется [**бета-тестированием**](https://ru.wikipedia.org/wiki/Бета-тестирование). Обычно найденные проблемы касаются оценочной функции. Пример — программа переоценивает материал и предпочитает взятия, которые значительно ухудшают её позицию.

Предлагаю назвать такой вид поиска ошибок **ручным несистематический поиском**. Именно такой способ ручного тестирования разработчики программ применяют в своей ежедневной практике. Его используют для общего тестирования функциональности, когда ещё нет никакой информации о реальных или возможных ошибках.

Поиск ручной потому, что его выполняет человек. Он играет полную партию против тестируемой программы. В этом процессе нет никакой автоматизации.

Поиск несистематический потому, что у него нет строго плана. И разработчик, и привлечённый шахматист просто играют несколько партий. Они рассчитывают, что случайно встретят ошибку программы в ходе одной из них. Если программа выигрывает все партии, то предполагается, что у неё нет явных ошибок. Очевидно, это  утверждение слишком сильное и не может быть верным. На самом деле в ходе нескольких партий ни одна из ошибок по счастливой случайности не воспроизвелась.

Эпоха ручного несистематического поиска продлилась примерно до середины 1990-х годов, когда команда Deep Blue начала играть против Гарри Каспарова. В этот период самыми сильными шахматными программами были те, в разработку которых вкладывалось больше всего ресурсов. Этими ресурсами были:

* Деньги на разработку специализированного оборудования (шахматные компьютеры и чипы).

* Время крайне дорогих в те годы разработчиков программ.

* Компьютерное время для тестирования и отладки программы.

* Время профессиональных шахматистов для тестирования программы.

Например, разработка одного из самых сильных шахматных компьютеров своего времени Belle велась за счёт средств корпорации Bell Labs. Кен Томпсон, сам будучи одним из пионеров компьютерной науки, пользовался передовым оборудованием компании и помощью своих не менее выдающихся коллег.

Значительные инвестиции ресурсов привели к огромному техническому превосходству компьютера Belle над конкурирующими шахматными проектами. В результате он выиграл чемпионат ACM в 1978 году. Так проект привлёк внимание шахматного сообщества. Дальше найти желающих профессионалов для игры с именитым компьютером стало намного проще. Это повысило качество тестирования его программы и исправления в ней ошибок.

### 3.6.1.2 Ручной систематический поиск

Команда Deep Blue была вынуждена изобрести новую стратегию тестирования шахматных программ. Ручной несистематический поиск просто не работал в условиях матча с чемпионом мира. Да, этот подход позволил создать самый сильный шахматный компьютер для своего времени. Но он показал свою несостоятельным в первом же матче против Гарри Каспарова в 1996 году.

Во-первых, команда Deep Blue разработала специальный инструментарий для тестирования оценочной функции. Мюррей Кэмпбелл добавил к ней графический интерфейс. Он позволил задавать произвольную шахматную позицию и выводить для неё результат оценочной функции. Таким образом отпала необходимость играть всю партию целиком, чтобы обнаружить какую-то конкретную ошибку. Вместо этого достаточно было просто ввести позицию из сыгранной ранее партии, где ошибка воспроизвелась. Дальше следовало понять причину неверного результата оценочной функции и исправить ошибку в коде.

Во-вторых, Джоэл Бенджамин играл не обычные тестовые партии против Deep Blue. После каждой своей ошибки шахматист брал ход назад и исправлял её. Этот подход значительно повысил эффективность тестирования. Он позволял человеку сыграть идеально против компьютера, значительно превосходящего его по силе. Когда оппонент играет идеально, компьютер тоже должен играть идеально. Если этого не происходит, проявляется какая-то ошибка в оценочной функции, которую надо проанализировать и исправить.

Предлагаю назвать такой вид поиска ошибок **ручным систематический поиском**. Разработчики программ применяют его, когда есть какая-то информация об ошибке. Например, условия в которых она проявляется.

Поиск систематический, потому что у него есть строгий план. Этот план выглядит примерно следующим образом:

1. Создать полностью повторяемую среду для воспроизведения ошибки. Это означает, что ни аппаратные средства, ни программные не должны меняться между тестами. Тестировщик всегда берёт один и тот же компьютер и запускает на нём одну и ту же версию программы.

2. Следовать повторяемым путём для воспроизведения ошибки. Это значит, что тестировщик на каждом тесте выполняет одни и те же действия, которые приводят к одним и тем же результатам. 

3. Каждый раз, когда воспроизводится ошибка, фиксировать ключевые особенности состояния программы и её среды (например, состояние аппаратуры). Именно одна из этих особенностей и провоцирует ошибку. Задача разработчика — понять какая именно.

Создать полностью повторяемую среду для разработчиков Deep Blue было очень просто. У них были шахматные процессоры собственного производства, они контролировали версию прошивки для них и версию управляющей программы.

Второй пункт выполнить гораздо сложнее. В алгоритме работы шахматной программы очень много случайностей. Из-за этого практически невозможно заставить её играть одну и ту же партию снова и снова. Дело не в том, что программа "запомнила" прошлую партию и не хочет повторяться. Дело именно в случайностях.

Если шахматная программа выполняется на нескольких процессорах, случайность выполнения её алгоритма связана с непредсказуемостью процесса параллельного исполнения кода. При первом запуске один процессор может получить на обработку одну часть дерева поиска. При повторном запуске, этот же процессор получает на обработку другую часть дерева поиска. На скорость работы процессора влияет множество физических параметров (например, температура его нагрева). Порядок в которому управляющая программа получает результаты алгоритма поиска, влияет на её решения. Если первый процессор нашел очень хороший ход, а второй процессор показал ход хуже, происходит альфа-бета отсечение. Но такое отсечение выкидывает из рассмотрения и очень хорошие варианты, к которым приводят **цепочки лучших ходов**.

I> Цепочка лучших ходов — это последовательность из лучших для текущей позиции ходов. Их очень трудно обнаружить человеку. Для машины находить такие цепочки намного легче. Именно на анализе цепочек лучших ходов строятся методы обнаружения мошенников, которые используют шахматные движки в турнирных партиях.

Допустим, что мы исключим случайность многопроцессорной системы. Например, наша шахматная программа работает на одном процессоре. Станет ли её реакция на действия оппонента более однообразной? Можно ли так заставить программу играть одну и ту же партию многократно? Ответ — нет.

Выполнением шахматной программы выполняет многозадачная операционная система. В каждый момент времени она выполняет только одну программу, которая получает все требуемые ей аппаратные ресурсы. ОС переключается между задачами так быстро, что с точки зрения пользователя все программы исполняются одновременно. Но в масштабах времени компьютера все программы исполняются по очереди, одна за другой.

Теперь вопрос — можно ли предсказать, как именно ОС будет переключать задачи? Если это обычная ОС для ПК, то переключение задач происходит абсолютно непредсказуемо. Именно из-за этой проблемы во всех критически важных **встраиваемых системах** (например, система управления автомобилем) используются специальные [**ОС реального времени**](https://ru.wikipedia.org/wiki/Операционная_система_реального_времени). Они гарантируют отклик системы на внешнее событие в заданных временных интервалах.

Итак чтобы заставить шахматную программу играть одну и ту же партию, для неё необходимо создать специальную аппаратную платформу и операционную систему, которая ведёт себя на подобие системы реального времени. Это чрезвычайно сложная и трудоёмкая задача.

Именно эту проблему повторяемости пути воспроизведения ошибки и решил Джоэл Бенджамин. Чего он добился своей игрой с "ходом назад"? Так он фиксировал некоторое состояние партии и изучал исходящие из него ветви дерева игры.

Допустим чисто в теории, что у Джоэла Бенджамина было бы специальное оборудование и ОС, которые бы исключали случайность в работе шахматной программы. Тогда он бы мог проигрывать одну и ту же партию до некоторой позиции. Затем он пробовал бы разные ходы в ней. Так он находил бы позицию, которая приводит к ошибке в оценочной функции. Но именно это же самое позволяют делать "ходы назад".

С третьим пунктом плана, у команды Deep Blue не было особых проблем. У них были средства для анализа состояния управляющей программы и прошивки шахматных процессоров. Так они могли собрать полную информацию о среде выполнения в состоянии ошибки. Дальше выяснить причину ошибки можно было перебором всех возможных вариантов.

Надеюсь, мне удалось показать важность вклада команды Deep Blue в методологию тестирования шахматных программ. Они разработали гораздо более эффективный подход для того, чтобы быстро и с минимальными трудозатратами находить и исправлять ошибки как оценочной функции, так и алгоритма поиска.

Строго говоря, второй матч Гарри Каспарова против Deep Blue 1997 года был не противостоянием человека и машины. Это было противостояние методологии ручного несистематического поиска ошибок, который применял чемпион, и ручного систематического поиска ошибок, которому следовала команда Deep Blue. Каждая случайно обнаруженная Каспаровым ошибка в одной партии быстро находилась и исправлялась до следующей партии командой Deep Blue. В такой ситуации у шахматиста просто не было возможности найти и эксплуатировать одну и ту же уязвимость программы. В каждой новой партии он должен был успеть найти новую уязвимость и суметь ею воспользоваться. Особый трагизм заключается в том, что в ходе матча сам Гарри Каспаров не до конца понимал правила этой игры.

Мог ли Гарри Каспаров выиграть Deep Blue без эксплуатации ошибок в оценочной функции или алгоритме поиска? Нет не мог из-за огромной вычислительной мощности Deep Blue. Если компьютер не ошибался из-за изъяна в программе, его теоретический уровень Эло был намного выше, чем уровень чемпиона. Причина в огромной глубине поиска по дереву игры. Ещё раз игра Deep Blue не была идеальной, когда его оценочная функция не ошибалась. Просто она была очень сильной и уже превосходила возможности человека.

### 3.6.1.3 Автоматический несистематический поиск

// TODO: Опыт Stockfish. Нахождение ошибок - побочный эффект тестирования изменений.

### 3.6.1.4 Автоматический систематический поиск

// TODO: Опыт AlphaZero

### 3.6.2 Автоматизация поиска ошибок

// TODO
