## 3.4 История шахматных программ

Рассмотрим лучшие шахматные программы, которые побеждали на турнирах среди программ. В результате развития они смогли победить чемпиона мира по шахматам. Сегодня шахматные программы не оставляют шансов профессиональным игрокам.

#### 3.4.1 История

##### 3.4.1.1 Шахматная программа Бернштейна

Первую полноценную шахматную программу разработал сотрудник IBM Алекс Бернштейн со своими коллегами в 1957 году. Она получила название [The Bernstein Chess Program](https://www.chessprogramming.org/The_Bernstein_Chess_Program) (шахматная программа Бернштейна).

Предыдущие системы такие как General Problem Solver могли решать некоторые шахматные задачи. Например, из заданной позиции они находили мат за два хода. Но такие программы не могли сыграть партию от начала до конца. В отличие от них программа Бернштейна могла сыграть партию целиком.

У Бернштейна было преимущество в том, что он использовал новейший компьютер от [IBM 704](https://ru.wikipedia.org/wiki/IBM_704). Это первый компьютер массового производства. По меркам 1950-х годов он был одним из самых производительных. Кроме этого Бернштейна консультировал американский гроссмейстер Артур Бисгайер.

{caption: "Иллюстрация 3-2. Алекс Берштейн тестирует свою программу на IBM 704"}
![Алекс Берштейн](images/Chess/alex-bernstein.jpg)

Шахматная программа Бернштейна использовала таблицы дебютов. Она распознавала известные в те годы начала партий и выбирала лучшие ходы по сохранённым в памяти таблицам.

Для игры в миттельшпиле шахматная программа Бернштейна использовала стратегию типа Б в терминологии Клода Шеннона.

В 1949 году Клод Шеннон опубликовал статью "Программирование компьютера для игры в шахматы" ("Programming a Computer for Playing Chess"). В ней он описал две стратегии для шахматных программ:

* [Стратегия типа A](https://www.chessprogramming.org/Type_A_Strategy)
* [Стратегия типа Б](https://www.chessprogramming.org/Type_B_Strategy)

Стратегия типа А заключается в просчёте наперёд всех возможных ходов и поиске среди них наилучшего. Шеннон полагал, что использующая эту стратегию шахматная программа будет слабым игроком. Причину этого он видел в большом коэффициенте ветвления дерева поиска и комбинаторном взрыве количества возможных позиций.

Стратегия типа Б прелагает просчитывать только небольшое подмножество наиболее перспективных ходов.

Шахматная программа Бернштейна использовала минимаксный алгоритм для просчёта восьми ходов вперёд. Чтобы начать расчёт вглубь, она выбирала семь наиболее перспективных ходов. Для этого выбора учитывались следующие качества позиции:

1. Выигрыш материала.
2. Подвижность фигур.
3. Контроль доски.
4. Безопасность короля.

В среднем программа тратила 8 минут на поиск хода. Она играла на уровне любителя.

##### 3.4.1.2 Шахматный компьютер Belle

В августе 1969 года Кен Томпсон и Деннис Ритчи разработали первый прототип операционной системы Unix для миникомпьютера PDP-7. Томпсон был любителем шахмат и решил написать пробную шахматную программу [Belle](https://www.chessprogramming.org/Belle, работающую на новой ОС.

Проект Belle начинался как программный. Позднее к Томпсону присоединился Джо Кондон. Он предложил разработать специальный компьютер, оптимизированный для расчёта шахматных ходов.

{caption: "Иллюстрация 3-3. Шахматный компьютер Belle"}
![Компьютер Belle](images/Chess/belle.jpg)

 Компьютер Belle состоял из трёх аппаратных модулей:

1. Генератор ходов ([move generator](https://www.chessprogramming.org/Move_Generation))

2. Модуль оценки позиции ([position evaluator](https://www.chessprogramming.org/Evaluation))

3. Таблица транспозиций ([transposition table](https://www.chessprogramming.org/Transposition_Table))

Генератор ходов использует эвристику под названием **самая ценная жертва, наименее ценный агрессор** (Most Valuable Victim - Least Valuable Aggressor или [MVV-LVA](https://www.chessprogramming.org/MVV-LVA). Идея этой эвристики — среди атакованных фигур противника найти самую ценную. Она называется жертвой. Ценность фигур убывает в таком порядке: ферзь, ладья, слон, конь, пешка. Следующий шаг — найти наименее ценную фигуру из тех, которые атакуют жертву. Такая фигура называется агрессором.

Несмотря на простоту, эвристика MVV-LVA находит список перспективных ходы во многих позициях. Получив такой список, шахматный компьютер просчитывает возможные позиции вперёд на глубину нескольких ходов. Для поиска по шахматному дереву он использует минимаксный алгоритм с альфа-бета отсечением.

Модуль оценки позиции даёт численную оценку каждой позиции, который рассматривает шахматный компьютер. Это может быть позиция, полученная в результате перспективного хода или наиболее вероятного ответа оппонента. Модуль оценки учитывает несколько факторов:

1. Позицию и безопасность короля в зависимости от стадии партии.

2. [Таблицу фигур и полей](https://www.chessprogramming.org/Piece-Square_Tables).

3. Пешечную структуру.

4. Мобильность фигур.

5. Открытые диагонали и линии.

Таблица фигур и полей составляется для каждой черной и белой фигуры. Таблица представляет собой численные оценки клеток, которые фигура может занять на доске. Чем выше оценка, тем выгоднее позиция. При этом расположение других фигур таблица не учитывает. Благодаря таблице, шахматная программа может быстро оценить насколько выгодно занимать фигурой ту или иную клетку на доске.

Третий аппаратный модуль Belle — таблица транспозиций. В ней сохраняются позиции, которые программа находит в результате всех выполненных итераций поиска. В одну и ту же позицию ведут разные последовательности ходов. Эти последовательности называются **транспозициями**. Благодаря таблице, компьютеру не приходится снова и снова оценивать одни и те же позиции. Это значительно ускоряет поиск по дереву игры.

Компьютер Belle использовал стратегию типа А в терминологии Клода Шеннона. Он перебирал все свои возможные ходы в текущей позиции. На каждый из них Belle рассматривал все возможные ответные ходы оппонента. Благодаря эвристикам, Belle удавалось значительно сокращать дерево поиска.

Первая версия Belle просчитывала партию на четыре хода вперёд. К 1978 году это число увеличилось до восьми ходов. В этому году компьютер впервые учавствовал и занял первое место на [Северо-Американском чемпионате по шахматам среди компьютерных программ](https://ru.wikipedia.org/wiki/Северо-Американский_чемпионат_по_шахматам_среди_компьютерных_программ) ([ACM North American Computer Chess Championship](https://www.chessprogramming.org/ACM_North_American_Computer_Chess_Championship)). После Belle ещё четыре раза выигрывал этот чемпионат.

В 1980 Belle выиграл [чемпионат мира по шахматам среди компьютерных программ](https://ru.wikipedia.org/wiki/Чемпионат_мира_по_шахматам_среди_компьютерных_программ) (World Computer Chess Championship или WCCC). А в 1982 компьютер достиг рейтинга в 2250 пунктов Эло, что соответствует уровню мастера.

##### 3.4.1.3 Шахматный компьютер Deep Blue

11 мая 1997 года шахматный компьютер [Deep Blue](https://ru.wikipedia.org/wiki/Deep_Blue) победил действующего чемпиона мира по шахматам Гарри Каспарова. История разработки компьютера началась задолго до этой памятной даты. Рассмотрим её вкратце.

###### 3.4.1.3.1 ChipTest

В 1979 году профессор Калифорнийского технологического института Карвер Мид и учёный Линн Конвей опубликовали книгу "Введение в сверхбольшие интегральные схемы". Она описывает правила проектирования схем и способы автоматизации это процесса. Книга положила начало [революции сверхбольших интегральных схем](https://en.wikipedia.org/wiki/Mead–Conway_VLSI_chip_design_revolution) (СБИС).

Многие университеты начали экспериментировать со СБИС. Одной из областей их применения стали шахматные компьютеры.

В 1985 году аспиранты университета Карнеги Мелоун Фэн Сюн Сю и Томас Анантараман работали над своей диссертацией. В ходе этой работы они создали шахматный компьютер под названием [ChipTest](https://en.wikipedia.org/wiki/ChipTest).

В 1986 году к проекту присоединился Мюррей Кемпбелл. До этого Кемпбелл состоял в группе разработки шахматного компьютера [HiTech](https://www.chessprogramming.org/HiTech) в том же университете. Основной фокус проекта HiTech был на специализированных СБИС. Они генерировали ходы и распознавали типичные позиции для функции оценки.

Проект ChipTest оказался успешным. Компьютер выиграл шахматные турниры ACM среди программ в 1986 и 1987 годах. В 1986 году компьютер просчитывал около 100000 позиций в секунду. К 1987 году это число увеличилось до 500000.

В 1987 году команду ChipTest пригласили на Открытый чемпионат Америки (American Open). Но разработчики отказались от участия из-за возражений команды HiTech. Оба проекта использовали некоторый общий программный код.

ChipTest использовал генератор ходов аналогичный компьютеру Belle. Он реализовал эвристику "самая ценная жертва, наименее ценный агрессор" (MVV-LVA) на аппаратном уровне. Для поиска по шахматному дереву ChipTest использовал типовые методы — минимаксный алгоритм с альфа-бета отсечением.

ChipTest хранил представление доски в виде массива 8x8 на уровне СБИС. Благодаря этому, он мог быстро оценивать позиции в узлах дерева поиска. Для оценки компьютер учитывал материал, размещение фигур, пешечную структуру, контроль полей и мобильность фигур.

Следующие шахматные компьютеры Deep Thought и Deep Blue, разработанные командой ChipTest, использовали аналогичные алгоритмы поиска ходов и оценки позиций.

###### 3.4.1.3.2 Deep Thought

Успехи ChipTest показали потенциал специализированных шахматных компьютеров. Команда проекта начала работу над новой машиной. Она получила название Deep Thought в честь вымышленного суперкомпьютера из романа Дугласа Адамса «Автостопом по галактике».

Первая версия 0.01 Deep Thought была разработана в мае 1988 года. В ноябре того же года появилась следующая версия 0.02. Она использовала две специальные СБИС для просчёта шахматных позиций. Благодаря им, компьютер мог просчитывать 720000 ходов в секунду.

Компьютер Deep Thought превосходил ChipTest по вычислительной мощности. Вместо одного шахматного процессора первая версия Deep Thought использовала два. Впоследствии их количество было увеличено до 24-х в версии Deep Thought II 1991 года. 

Кроме преимущества в аппаратной части Deep Thought использовал улучшенную оценочную функцию. Она учитывала больше позиционных факторов, чем функция ChipTest. Для некоторых факторов команда Фенг Хсу впервые применила [автоматическую настройку](https://www.tim-mann.org/deepthought.html). Её идея в расчёте важности тех или иных факторов позиции на основе базы данных из 868 игр между гроссмейстерами. В результате автоматической настройки Deep Thought предпочитал те же ходы, что и гроссмейстеры в изученных им партиях. Благодаря этим улучшениям, уровень игры Deep Thought был намного выше чем у ChipTest.

В 1988 году Deep Thought выиграл турнир ACM. В 1989 компьютер победил на 6-ом чемпионате мира среди компьютерных программ (WCCC) со счётом 5-0, не проиграв ни одной партии. В этом же году Deep Thought достигла рейтинга Эло 2551, который соответствует международному гроссмейстеру.

{caption: "Иллюстрация 3-4. Команда Deep Thought в 1988 году: Мюррей Кемпбелл, Фэн Сюн Сю, Томас Анантараман, Майкл Браун, Андреас Новатчук"}
![Команда Deep Thought](images/Chess/deep-thought-team.jpg)

Deep Thought стал первым компьютером, который смог обыграть гроссмейстера на турнире с классическим контролем времени. Это была партия с известным датским шахматистом [Бентом Ларсеном](https://ru.wikipedia.org/wiki/Ларсен,_Бент) на чемпионате, организованном американской компанией по разработке видеоигр Software Toolworks в 1988 году.

В 1989 году состоялся матч из двух игр между Deep Thought и действующим чемпионом мира Гарри Каспаровым. Каспаров легко одолел компьютер в обеих партиях. Этот матч продемонстрировал недостатки шахматных компьютеров того времени:

1. Жадность к материалу. Компьютеры охотно разменивали позиционное преимущество на материал. Кроме того они всеми силами пытались избежать потери фигур. Это часто приводило к плохим позициям.

2. Отсутствие позиционной игры. Если не было очевидно хороших ходов, компьютер не развивал свою позицию, а терял время совершая бессмысленные ходы.

Каспаров умело воспользовался этими недостатками. [В первой партии](https://lichess.org/j0Vfex0w#1) он последовательно наращивал позиционное преимущество. Когда оно стало значительным, шахматист преобразовал его в материальное и поставил мат Deep Thought.

[Во второй партии](https://lichess.org/1l9BGxUL#73) Каспаров пожертвовал коня, благодаря чему смог провести сильную атаку на короля. В результате этой атаки он получил материальное преимущество, достаточное для победы. Deep Thought не смог правильно оценить последствий этой жертвы. Она дала Каспарову позиционное преимущество, которое он реализовал только через несколько ходов. Компьютер был не способен просчитать ходы на такую глубину и поэтому не увидел опасности.

Матч Deep Though с Каспаровым показал, что компьютеры конца 1980-х были не готовы составить серьёзную конкуренцию профессиональным шахматистам.

###### 3.4.1.3.3 Deep Blue

Шахматные компьютеры конца 1980-х и начала 1990-х приблизились к игре на уровне гроссмейстера. На классическом контроле времени их уровень Эло составлял примерно 2300-2400 пунктов. В блиц партиях сила компьютеров повышалась на 100-200 пунктов. Когда у человека было меньше времени на размышление, машина получала преимущество. В блиц турнирах компьютеры показывали [очень хорошие результаты](https://habr.com/ru/post/362643/) в начале 1990-х.

В то время существовало два пути развития шахматных компьютеров:

1. Улучшать программную составляющую, а именно алгоритм перебора ходов и оценочную функцию. 

2. Улучшать аппаратную часть, то есть увеличивать вычислительную мощность и число перебираемых ходов.

Оба пути давали результат: более совершенные алгоритмы выигрывали у слабых, а более быстрые машины — у медленных.

Проблема первого пути была в большой трудоёмкости. Алгоритмы и эвристики поиска развивались методом проб и ошибок. Некоторые новые эвристики эффективно сокращали дерево поиска. При этом они отсеивали не только плохие ходы, но и очень хорошие. Такое поведение было нежелательно. Поэтому каждое изменение алгоритма требовало многократного тестирования.

Чтобы улучить оценочную функцию, нужна консультация профессионального шахматиста. Причём каждое изменение надо было тестировать с его участием. Этот процесс требовал много времени и сил. К сожалению, многие команды разработчиков не имели поддержки со стороны гроссмейстеров из-за ограниченных ресурсов.

Второй путь развития требовал значительных финансовых затрат. У разработчиков-энтузиастов часто не было ресурсов и опыта, чтобы самостоятельно создавать СБИС. Поэтому путём совершенствования аппаратуры шли команды из университетов или крупных корпораций. Это было надёжное направление развития шахматных компьютеров, которое могло дать прибавку в 300-400 пунктов Эло к среднему для тех времён уровню машин.

Многие команды разработчиков мечтали достичь уровня игры Гарри Каспарова с уровнем Эло 2800 пунктов. Однако, в конце 1980-х на это могли рассчитывать только большие шахматные компьютеры с высокой вычислительной мощностью. Именно поэтому такими компьютерами заинтересовалась корпорация IBM.

В 1989 году руководство IBM запустило [проект по созданию шахматного суперкомпьютера](https://habr.com/ru/post/363077/). Компания IBM решила не создавать команду с нуля, а нанять уже опытных разработчиков. Поэтому с самого начала компания нацелилась на команду Deep Thought. Среди шахматных компьютеров того времени это был самый известный и успешный. В течении 1989 и 1990 годов разработчики Deep Though заканчивали обучение в Карнеги Мелоун и переходили на работу в IBM. В команду входили Томас Анансараман, Фэн Сюн Сю и Мюррей Кэмпбелл.

Команда Фэн Сюн Сю выбрала второй путь развития своего компьютера. Разработчики сконцентрировались на совершенствовании аппаратной части. Они поставили себе цель вместить все функции СБИС Deep Thought в специализированный микропроцессор.Он представлял собой один кристалл кремния.

{caption: "Иллюстрация 3-5. Плата расширения Deep Blue с восемью микропроцессорами"}
![Плата расширения Deep Blue](images/Chess/deep-blue-microprocessors.jpg)

Переход от СБИС к микропроцессору значительно повышал производительность: от 720000 до 2 млн. ходов в секунду. Кроме этого микропроцессор открывал возможности для масштабирования. Суперкомпьютер мог включать всего несколько десятков СБИС. С другой стороны он мог поддерживать одновременную работу сотен микропроцессоров. В финальной версии Deep Blue их было 480.

Новый шахматный суперкомпьютер получил название Deep Blue. Это сочетание имени проекта Deep Thought и неофициального прозвища IBM Big Blue (голубой гигант).

В 1995 году команда Фэн Сюн Сю закончила разработку шахматного микропроцессора. В сентябре того же года была создана первая версия компьютера Deep Blue I на основе двух микропроцессоров.

Разработчики понимали: одной вычислительной мощности машине не хватит, чтобы справиться с Каспаровым. Поэтому IBM наняла американского гроссмейстера [Джоэла Бенджамина](https://ru.wikipedia.org/wiki/Бенджамин,_Джоэль). Он должен был тестировать Deep Blue и давать советы по улучшению оценочной функции.

В феврале 1996 года состоялся матч между [Deep Blue I и Гарри Каспаровым](https://habr.com/ru/post/365045/). В матче было шесть партий. В первой компьютер одержал уверенную победу. После поражения Каспаров подстроился под стратегию компьютера. Он выиграл вторую партию и свёл на ничью третью и четвертую. Последние две партии чемпион мира выиграл. В итоге Deep Blue проиграла матч со счётом 2:4.

Матч между Deep Blue I и Каспаровым дал команде IBM информацию о слабых сторонах компьютера. Фэн Сюн Сю и его коллеги были настроены оптимистично. Они видели пути улучшения игры Deep Blue.

Прежде всего матч с Каспаровым показал, что производительности шахматного микропроцессора достаточно для игры на высшем уровне. Deep Blue I проверял около 100 млн. позиций в секунду. Проблема компьютера была в стратегии и понимании тонкостей разных позиций. Чемпион мира одержал победу именно благодаря лучшей стратегической игре.

Разработчики Deep Blue сделали основной упор на тестирование оценочной функции. Этой задачей занимался Джоэль Бенджамин. Он играл с программой Deep Blue, адаптированной для персонального компьютера. Программа называлась Deep Blue Junior. Её было проще запускать и изменять, чем версию для суперкомпьютера.

Бенджамин обнаружил несколько проблем в игре Deep Blue Junior. Программа недооценивала важность контроля за вертикальными линиями. Кроме того она неправильно боролась за этот контроль. Те же самые ошибки Deep Blue Junior совершал, когда надо было бороться за диагонали с помощью слонов.

Другая проблема Deep Blue Junior была в переоценке безопасности короля. Программа предпочитала защищать короля другими фигурами в течении всей партии. Бенджамин предложил менять важность такой защиты в зависимости от стадии игры и позиции. В дебюте и миттельшпиле программа всё так же уделяла внимание защите короля. Но в эндшпиле её поведение изменили. Теперь Deep Blue Junior предпочитал активно использовать короля в конце партии наравне с другими фигурами.

Для финального тестирования суперкомпьютера IBM пригласила известного шахматиста Мигеля Ильескаса. Он играл на турнирах того же уровня, что и Каспаров. По результатам игр Ильескас указал на проблемы в оценочной функции Deep Blue.

В команду шахматистов, которые работали с Deep Blue входили и другие гроссмейстеры: Ник де Фирмиан, Джон Федорович, Ларри Кристиансен, Майкл Роде. Они помогали Бенджамину подготавливать дебютную книгу для компьютера. По ней Deep Blue отыгрывал стандартные дебюты.

Параллельно с работой над оценочной функцией Deep Blue Фэн Сюн Сю работает над совершенствованием шахматного микропроцессора. В его конструкцию внесли значительные изменения. Это позволило увеличить его производительность. В результате новая версия компьютера Deep Blue II перебирала в два раза больше позиций в секунду (около 200 млн), чем предыдущая.

[Второй матч между Каспаровом и усовершенствованным Deep Blue II](https://habr.com/ru/post/390713/) состоялся в мае 1997 года. Так же как и первый матч, он состоял из шести партий. Каспаров уверенно выиграл первую партию, благодаря сильной игре. Во второй партии шахматист допустил стратегическую ошибку и проиграл. В следующих трёх партиях результатом была ничья.

В решающей шестой партии Deep Blue сделал нетипичный для компьютеров ход: пожертвовал коня в дебюте. На самом деле Deep Blue взял этот ход из дебютной книги, а не пришел к нему сам в результате анализа позиции. Каспаров оказался не готов к такому ходу и совершил ошибку. В итоге он проиграл партию и матч со счётом 3½:2½.

После матча Каспаров высказал претензии к IBM. Он утверждал, что игра была нечестная и некоторые ходы за Deep Blue делал гроссмейстер. Причина подозрений была в том, что игра компьютера была неровной. Иногда после плохого хода, Deep Blue делал очень хороший и наоборот.

IBM представила распечатки log-файлов. Из них стало понятно, что все ходы Deep Blue делал самостоятельно. Неровная игра компьютера объясняется **эффектом горизонта**. Deep Blue рассчитывал позицию, например, на 7 ходов вперёд. Однако, на 8 ходу у оппонента есть сильный ответный ход, который сводит на нет всю комбинацию. После первого хода в комбинации Deep Blue обнаруживает сильный ответ противника. В этом случае компьютер меняет свой план. Тогда уже сделанный ход оказывается слабым или даже ошибкой.

Каспаров настаивал на матче-реванше, но IBM отклонила это предложение. После победы Deep Blue над чемпионом мира цена на акции компании взлетела. Это был отличный маркетинговый ход, который подкрепил репутацию IBM среди инвесторов и принёс большую прибыль. Однако, сыгранные партии показали опытным шахматистам, что Deep Blue II играет не сильнее чемпиона мира. Поэтому результат матча-реванша мог оказаться любым. Поражение Deep Blue могло свести на нет все маркетинговые успехи IBM. Компания решила отказаться от такого риска.

#### 3.4.2 Современные шахматные программы

В конце 1990-х годов шахматные программы для ПК достигли уровня игры специализированных суперкомпьютеров наподобие Deep Blue. В результате новые разработки представляли собой именно программы. Компании и энтузиасты перестали разрабатывать специализированное шахматное аппаратное обеспечение, потому что это было слишком дорого.

Как настольные компьютеры достигли уровня игры суперкомпьютеров? Во-первых, значительно увеличилась мощность ПК. Большая часть таких компьютеров имела [IBM-совместимую](https://ru.wikipedia.org/wiki/IBM-PC-совместимый_компьютер) архитектуру и работала на процессорах от Intel. В 1993 году вышел процессор [Intel Pentium](https://ru.wikipedia.org/wiki/X86#Процессоры_Intel). К концу 1990-х его конструкция была усовершенствована. Так доступные ПК получили мощный и недорогой процессор. Его производительности хватало шахматным программам, чтобы просчитывать ходы на глубину, достаточную для качественной игры.

Второе причина — это совершенствование самих шахматных программ. Основные улучшения касались оценочной функции. Благодаря им, программы качественнее оценивали позиции и выбирали более сильные ходы. Так же появились новые эвристики поиска. Это позволяло программам отбрасывать больше бесперспективных ходов и глубже просчитывать перспективные.

##### 3.4.2.1 Шахматные движки

В 1993 году разработчик шахматных программ [Мартин Хирш](https://www.chessprogramming.org/Marty_Hirsch) ввёл термин [**шахматный движок**](https://ru.wikipedia.org/wiki/Шахматный_движок). Хирш сделал это чтобы отличать коммерческие шахматные игры от инструментов для профессиональных шахматистов.

Шахматные игры начали появляться в конце 1980-х годов для ПК. Примеры таких игр: [Chessmaster](https://en.wikipedia.org/wiki/Chessmaster) и [Battle Chess](https://en.wikipedia.org/wiki/Battle_Chess). Такие программы имели красивый графический интерфейс. Например, в Battle Chess после каждого хода фигуры оживают и перемещаются на указанное поле доски. Если это поле уже занимает фигура противника, то происходит сражение. Шахматные игры предназначались для широкой аудитории. Они продавались по низкой цене и позиционировались как развлечения. Их уровень игры был низким: около 1600 пунктов Эло.

В отличие от игр, шахматные движки не имеют графического интерфейса. Они предназначены для анализа заданной позиций и поиска в ней наилучшего хода. Пользователь работает с такой программой через интерфейс командной строки. Шахматные движки изначально позиционировались как инструменты для профессионалов. С их помощью шахматисты анализировали партии и готовились к турнирам. Соответственно цена на шахматные движки была высокой, как и на любой профессиональный инструмент. Их уровень игры был намного выше чем у шахматных игр.

Интерфейс командной строки был неудобен для большинства пользователей. Поэтому в начале 1990-х стали появляться программы для визуализации работы шахматного движка. Большинство современных программ визуализации коммерческие и достаточно дорогие. При этом наиболее сильные шахматные движки бесплатны и распространяются с [открытым исходным кодом](https://ru.wikipedia.org/wiki/Свободное_и_открытое_программное_обеспечение).

Далее мы рассмотрим самые сильные современные шахматные движки.

##### 3.4.2.2 Stockfish

Stockfish считается сильнейшим современным шахматным движком. Он занимает первые строчки в рейтингах [Chess Engines Grand Tournament](http://www.cegt.net/40_40 Rating List/40_40 BestVersion/rangliste.html) (CEGT) и [Computer Chess Rating Lists](https://ccrl.chessdom.com/ccrl/4040/) (CCRL) за 2022 год.

Stockfish представляет собой развитие шахматного движка Glaurung, разработанного Тордом Ромстадом. Первая версия Glaurung вышла в 2004 году. Это была программа для ПК с открытым исходным кодом. Её более поздние версии были портированы на мобильные телефоны и планшеты.

В ноябре 2008 году Марко Костальба решил сделать [**форк**](https://ru.wikipedia.org/wiki/Форк) проекта (от английского fork — вилка). Форком называется использование кодовой базы одного проекта в качестве старта для другого. Костальба назвал свой проект Stockfish. Первая версия этого движка вышла в ноябре 2008 года.

В течение 2008 года Glaurung и Stockfish развивались параллельно. Оба проекта распространялись с открытым исходным кодом. Поэтому идеи и усовершенствования алгоритмов свободно передавались из одного проекта в другой.

В декабре 2008 года Ромстад выпустил последнюю версию Glaurung 2.2. Он решил прекратить поддержку своего проекта и присоединился к команде Stockfish. Причиной этого решения стал тот факт, что Stockfish превзошёл Glaurung по уровню игры.

В 2011 году Ромстад вышел из проекта Stockfish. Он занялся разработкой шахматной программы для iOS. В 2014 году проект покинул Марко Костальба. Современная версия Stockfish развивается группой энтузиастов.

Stockfish достиг высокого уровня игры благодаря специальной системе распределённых тестов под названием Fishtest. Её разработал Гэри Линскотт в 2013 году. Система Fishtest позволяет добровольцам выделять процессорное время своих компьютеров на тестирование шахматного движка. Суть тестирования заключается в многократных играх модифицированной версии Stockfish против последней стабильной версии. Только статистически значимые улучшения принимаются сообществом разработчиков.

Эффективность Fishtest можно оценить по первым 12 месяцам его использования. За это время уровень игры Stockfish вырос на 120 пунктов Эло. В результате этого прогресса Stockfish поднялся до лидирующих позиций во всех основных рейтингах шахматных движков.

К декабрю 2022 года благодаря системе Fishtest движок Stockfish сыграл около 5 миллиардов шахматных партий. На это ушло более 8650 лет процессорного времени.

До 2020 года движок Stockfish состоял из двух механизмов:

1. Поиск
2. Статическая оценка позиции.

Механизм поиска типичен для современных шахматных программ — это минимаксный поиск с альфа-бета отсечением.

Чтобы сделать эвристику альфа-бета отсечения более эффективной, необходимо сортировать ходы. В первую очередь лучше рассматривать наиболее перспективные ходы. Тогда большую часть остальных ходов удастся отсечь. Эта оптимизация называется [**move ordering**](https://www.chessprogramming.org/Move_Ordering) (сортировка ходов).

Stockfish реализует move ordering с помощью эвристик под названием **истории ходов**. Одна из них — это **continuation history** (история ответных ходов). Если Stockfish играет серию партий, он запоминает результаты своих ответных ходов на ходы противника. Например противник ходит конём на f6, а шахматный движок отвечает слоном на c4. Если ход оказался успешным, он получает положительную оценку. В противном случае оценка хода будет отрицательная. Далее когда противник ходит конём на f6 в другой позиции, Stockfish сортирует ход слоном на c4 в зависимости от его оценки по прошлым партиям.

Кроме истории ответных ходов Stockfish запоминает историю своих успешных последовательностей ходов. Например, в одной из сыгранных партий после хода конь f3, ход конь g5 был успешным. В этом случае движок даёт ходу конь g5 положительную оценку. В следующей партии поле хода конь f3 Stockfish рассмотрит последующий ход на g5 в первую очередь.

Состояние доски представляется в виде [**магических битбордов**](https://www.chessprogramming.org/Magic_Bitboards) Их идею хорошее объясняет следующее [видео](https://www.youtube.com/watch?v=K0rp1vXV3Ek).

###### 3.4.2.2.1 Магические битборды

Впервые на практике [битборды](https://hmn.wiki/ru/Bitboard) использовал Кристофер Стрейч в своей программе для игры в шашки в 1952 году. Битборды в шахматах впервые применили разработчики советской шахматной программы [Каисса](https://ru.wikipedia.org/wiki/Каисса_(программа)) в конце 1960-х годов.

Идея битбордов в том, чтобы оптимизировать обработку состояния доски. Битборд представляет собой одно 64-разрядное число. Каждый бит этого числа соответствует одному из 64-х полей шахматной доски. Если бит равен единице, поле занято фигурой. Если бит равен нулю, то поле свободно.

Чтобы сохранить состояние всех фигур на шахматной доске, нужно минимум восемь битбордов. По одному на каждый тип фигуры: пешки, ладьи, кони, слоны, короли, ферзи. Два битборда нужны для определения цвета фигуры на каждом поле: черный или белый.

Какие преимущества дают битборды? Современные процессоры работают с 64-разрядными регистрами. Это означает, что один битборд целиком помещается в один регистр. Поэтому одну проверка процессор выполняет за одну операцию. Благодаря этому, современные шахматные программы достигают очень высокой производительности.

Битборды хранят состояния доски. Но они не дают все доступные ходы для каждой фигуры. Доступные ходя для пешек, коней и королей рассчитываются просто с использованием битовых сдвигов. Проблема возникает для [**скользящих фигур**](https://www.chessprogramming.org/Sliding_Pieces) (sliding pieces): слон, ладья ферзь.

Чтобы получить доступные ходы для скользящих фигур, используют один из двух подходов: [**вращаемые битборды**](https://habr.com/ru/post/155045/) или [**магические битборды**](https://habr.com/ru/post/272815/). На современных процессорах магические битборды дают лучшую производительность. Поэтому все шахматные движки сегодня используют именно их.

Идея магических битбордов в **кешировании** всех доступных ходов для всех фигур с учётом всех возможных позиций блокирующих фигур. Кеширование означает однократный рассчёт и сохранение результата в памяти для повторного использования. Результат кеширования сохраняется в двумерных массивах. Каждый массив, соответствует одному типу фигур. Первый индекс массива — это поле, которое занимает фигура. Второй индекс — битборд с блокирующими фигурами.

Проблема с кешированием в том, что количество битбордов с блокирующими фигурами огромно. Оно равно 2^64^. Чтобы подсчитать необходимую память, умножим 2^64^ на 64 и получим 2^76^ бит или 2^36^ терабайт. Подход магических битбордов решают задачу экономии памяти. Его идея в том, чтобы использовать хэш-функцию, которая вместо 64-битного битборда блокирующих фигур даст меньшее число. Такое преобразование возможно, потому что в битборде блокирующих фигур нас интересует только первая блокирующая фигура на каждом направлении. Фигуры за ней не важны для расчёта доступных ходов.

##### 3.4.2.3 AlphaZero

##### 3.4.2.4 Leela Chess Zero
