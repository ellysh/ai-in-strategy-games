## 3.4 История шахматных программ

Перед тем как познакомиться с современными шахматными программами, обратимся к истории. Основные принципы их работы были опробованы на практике в 1960-х годах. С тех пор компьютеры значительно усовершенствовались, но ключевые идеи самих шахматных программ мало изменились.

### 3.4.1 Шахматная программа Бернштейна

Первую полноценную шахматную программу разработал сотрудник IBM Алекс Бернштейн со своими коллегами в 1957 году. Она получила название [The Bernstein Chess Program](https://www.chessprogramming.org/The_Bernstein_Chess_Program) (шахматная программа Бернштейна).

Предыдущие системы такие как General Problem Solver могли решать некоторые шахматные задачи. Например, из заданной позиции они находили мат за два хода. Но такие программы не могли сыграть партию от начала до конца. В отличие от них программа Бернштейна могла сыграть партию целиком.

У Бернштейна было преимущество в том, что он использовал новейший компьютер от [IBM 704](https://ru.wikipedia.org/wiki/IBM_704). Это первый компьютер массового производства. По меркам 1950-х годов он был одним из самых производительных. Кроме этого Бернштейна консультировал американский гроссмейстер Артур Бисгайер.

{caption: "Иллюстрация 3-2. Алекс Берштейн тестирует свою программу на IBM 704"}
![Алекс Берштейн](images/Chess/alex-bernstein.jpg)

Шахматная программа Бернштейна использовала таблицы дебютов. Она распознавала известные в те годы начала партий и выбирала лучшие ходы по сохранённым в памяти таблицам.

Для игры в миттельшпиле шахматная программа Бернштейна использовала стратегию типа Б в терминологии Клода Шеннона.

В 1949 году Клод Шеннон опубликовал статью "Программирование компьютера для игры в шахматы" ("Programming a Computer for Playing Chess"). В ней он описал две стратегии для шахматных программ:

* [Стратегия типа A](https://www.chessprogramming.org/Type_A_Strategy)
* [Стратегия типа Б](https://www.chessprogramming.org/Type_B_Strategy)

Стратегия типа А заключается в просчёте наперёд всех возможных ходов и поиске среди них наилучшего. Шеннон полагал, что использующая эту стратегию шахматная программа будет слабым игроком. Причину этого он видел в большом коэффициенте ветвления дерева поиска и комбинаторном взрыве количества возможных позиций.

Стратегия типа Б прелагает просчитывать только небольшое подмножество наиболее перспективных ходов.

Шахматная программа Бернштейна использовала минимаксный алгоритм для просчёта восьми ходов вперёд. Чтобы начать расчёт вглубь, она выбирала семь наиболее перспективных ходов. Для этого выбора учитывались следующие качества позиции:

1. Выигрыш материала.
2. Подвижность фигур.
3. Контроль доски.
4. Безопасность короля.

В среднем программа тратила 8 минут на поиск хода. Она играла на уровне любителя.

### 3.4.2 Шахматный компьютер Belle

В августе 1969 года Кен Томпсон и Деннис Ритчи из Bell Labs разработали прототип операционной системы Unix для миникомпьютера PDP-7. Томпсон был любителем шахмат и решил написать пробную шахматную программу [Belle](https://www.chessprogramming.org/Belle, работающую на новой ОС.

Проект Belle начинался как программный. Позднее к Томпсону присоединился его коллега Джо Кондон. Он предложил разработать специальный компьютер, оптимизированный для расчёта шахматных ходов.

В своей работе Джо Кондон использовал стандартные чипы серийного производства, которые были легко доступны. Таким образом он собирал специализированный шахматный компьютер на стандартных компонентах. В результате между компонентами компьютера были многочисленные проводные соединения. Такая архитектура выполняла шахматные расчёты быстрее, чем компьютеры общего назначения. Однако, у неё оставался потенциал для улучшения.

Чипы в компьютере Bell представляли собой малые (МИС) и [средние интегральные схемы](https://ru.wikipedia.org/wiki/Интегральная_схема#По_степени_интеграции) (СИС). Такие схемы содержат от 100 до 1000 элементов на одном кристалле.

{caption: "Иллюстрация 3-3. Шахматный компьютер Belle"}
![Компьютер Belle](images/Chess/belle.jpg)

 Компьютер Belle состоял из трёх аппаратных модулей:

1. Генератор ходов ([move generator](https://www.chessprogramming.org/Move_Generation))

2. Модуль оценки позиции ([position evaluator](https://www.chessprogramming.org/Evaluation))

3. Таблица транспозиций ([transposition table](https://www.chessprogramming.org/Transposition_Table))

**Генератор ходов** использует эвристику под названием **самая ценная жертва, наименее ценный агрессор** (Most Valuable Victim - Least Valuable Aggressor или [MVV-LVA](https://www.chessprogramming.org/MVV-LVA). Идея этой эвристики — среди атакованных фигур противника найти самую ценную. Она называется жертвой. Ценность фигур убывает в таком порядке: ферзь, ладья, слон, конь, пешка. Следующий шаг — найти наименее ценную фигуру из тех, которые атакуют жертву. Такая фигура называется агрессором.

Несмотря на простоту, эвристика MVV-LVA находит список перспективных ходы во многих позициях. Получив такой список, шахматный компьютер просчитывает возможные позиции вперёд на глубину нескольких ходов. Для поиска по шахматному дереву он использует минимаксный алгоритм с альфа-бета отсечением.

**Модуль оценки позиции** даёт численную оценку каждой позиции, который рассматривает шахматный компьютер. Это может быть позиция, полученная в результате перспективного хода или наиболее вероятного ответа оппонента. Модуль оценки учитывает несколько факторов:

1. Позицию и безопасность короля в зависимости от стадии партии.

2. Таблицу фигур и полей.

3. Пешечную структуру.

4. Мобильность фигур.

5. Открытые диагонали и линии.

[**Таблица фигур и полей**](https://www.chessprogramming.org/Piece-Square_Tables) составляется для каждой черной и белой фигуры. Таблица представляет собой численные оценки клеток, которые фигура может занять на доске. Чем выше оценка, тем выгоднее позиция. При этом расположение других фигур таблица не учитывает. Благодаря таблице, шахматная программа может быстро оценить насколько выгодно занимать фигурой ту или иную клетку на доске.

Третий аппаратный модуль Belle — **таблица транспозиций**. В ней сохраняются позиции, которые программа находит в результате всех выполненных итераций поиска. В одну и ту же позицию ведут разные последовательности ходов. Эти последовательности называются **транспозициями**. Благодаря таблице, компьютеру не приходится снова и снова оценивать одни и те же позиции. Это значительно ускоряет поиск по дереву игры.

Компьютер Belle использовал стратегию типа А в терминологии Клода Шеннона. Он перебирал все свои возможные ходы в текущей позиции. На каждый из них Belle рассматривал все возможные ответные ходы оппонента. Благодаря эвристикам, Belle удавалось значительно сокращать дерево поиска.

Первая версия Belle просчитывала партию на четыре хода вперёд. К 1978 году это число увеличилось до восьми ходов. В этому году компьютер впервые учавствовал и занял первое место на [Северо-Американском чемпионате по шахматам среди компьютерных программ](https://ru.wikipedia.org/wiki/Северо-Американский_чемпионат_по_шахматам_среди_компьютерных_программ) ([ACM North American Computer Chess Championship](https://www.chessprogramming.org/ACM_North_American_Computer_Chess_Championship)). Организатором чемпионата была [Ассоциация вычислительной техники](https://ru.wikipedia.org/wiki/Ассоциация_вычислительной_техники) (Association for Computing Machinery, ACM) — старейшая и наиболее крупная международная организация в компьютерной области с штаб-квартирой в Нью-Йорке. Позже Belle ещё четыре раза выигрывал этот чемпионат.

В 1980 Belle выиграл [чемпионат мира по шахматам среди компьютерных программ](https://ru.wikipedia.org/wiki/Чемпионат_мира_по_шахматам_среди_компьютерных_программ) (World Computer Chess Championship или WCCC), который проходил в австрийском городе Линц.

В 1983 году компьютер Belle достиг рейтинга в 2250 пунктов Эло, что соответствует уровню мастера. За это достижение его команда получила первую [премию Фредкина](https://www.chessprogramming.org/Edward_Fredkin#Prize) в размере 5000$.

Премию Фредкина учредил университет Карнеги — Меллон в 1980 году. Основная сумма составляла 100000$ за победу над действующим чемпионом мира по шахматам. Средства предоставлял фонд, основанный профессором Массачусетского технологического института Эдвардом Фредкином. Поэтому награда получила название премия Фредкина. Она состояла из трёх частей:

1. 5000$ за достижения уровня игры мастер.
2. 10000$ за достижения уровня игры интернациональный мастер.
3. 100000$ за победу над действующим чемпионом мира.

Премия Фредкина по замыслу учредителей должна была стимулировать исследования в компьютерных шахматах.

### 3.4.3 Шахматный компьютер Deep Blue

11 мая 1997 года шахматный компьютер [Deep Blue](https://ru.wikipedia.org/wiki/Deep_Blue) победил действующего чемпиона мира по шахматам Гарри Каспарова. Этот компьютер разрабатывала небольшая группа исследователей на протяжении 10 лет. Как им это удалось?

#### 3.4.3.1 ChipTest

В 1979 году профессор Калифорнийского технологического института Карвер Мид и учёный Линн Конвей опубликовали книгу "Введение в сверхбольшие интегральные схемы". В ней авторы описали правила проектирования схем и способы автоматизации это процесса. Книга положила начало [революции сверхбольших интегральных схем](https://en.wikipedia.org/wiki/Mead–Conway_VLSI_chip_design_revolution) (СБИС).

Многие университеты начали экспериментировать со СБИС. Одной из областей их применения стали шахматные компьютеры.

С середины 1980-х в университете Карнеги — Меллона группа аспирантов и преподавателей разрабатывала шахматный компьютер [HiTech](https://www.chessprogramming.org/HiTech). Руководил проектом заслуженный эксперт по шахматным программам профессор [Ханс Берлинер](https://www.chessprogramming.org/Hans_Berliner).

Идея HiTech напоминала проект Belle: собрать специализированный компьютер на стандартных чипах серийного производства. В отличие от Belle эти чипы представляли собой СБИС и имели больше возможностей.

Компьютер HiTech состоял из трёх аппаратных модулей:

1. Генератор ходов.

2. Модуль оценки позиции.

3. **Модуль контроля поиска** — определяет порядок, в котором шахматный компьютер исследует последовательности ходов.

Особенность проекта заключалась не в производительном оборудовании, а в новом методе поиска. Его разработал Берлинер в начале 1980-х и назвал B* по аналогии с типами шахматных программ A и B Шеннона. B* — это выборочный поиск, который просчитывает глубже перспективные ходы. В то же время он сокращает просчёт менее перспективных ходов.

Для разработки аппаратной части HiTech Берлинер привлекал аспирантов. В 1985 году профессор обратился к [Фэн Сюн Сю](https://www.chessprogramming.org/Feng-hsiung_Hsu), который тремя годами ранее переехал в США из Тайваня и поступил на кафедру информатики (computer science) в университет Карнеги — Меллон.

К этому моменту Фэн Сюн Сю уже имел опыт разработки чипов с нуля. Он учавствовал в коммерческом проекте для General Electrics, который кафедра выполняла совместно с японской компанией Matsushita Electric. Работа над этим проектом со стороны кафедры была закончена к 1985 году.

Берлинер предложил Фэн Сюн Сю заняться модулем оценочной функции. К этому моменту у HiTech уже был генератор ходов, который выполнялся на 64-х чипах. Каждому полю доски соответствовал один чип. На этих же самых чипах должна была выполняться и оценочная функция.

Опираясь на свой опыт, Фэн Сюн Сю предложил пересмотреть архитектуру HiTech. Его идея была в том, чтобы использовать специализированные чипы вместо стандартных. Сю упростил схему генератора ходов HiTech и придумал способ разместить его на одном специализированном СБИС чипе вместо 64-х стандартных. Далее он придумал как оптимизировать модуль оценочной функции. Это позволило поместить его в тот же чип, что и генератор ходов. Таким образом Сю получил шахматный компьютер, размещённый на одном единственном чипе.

Переход к системе на одном чипе увеличивал производительность шахматного компьютера примерно в 20 раз. Однако, Берлинер отклонил предложение Фэн Сюн Сю. По его мнению основная игровая сила HiTech заключалась не в скорости поиска, а в алгоритме B*. Этот алгоритм выполнял модуль контроля поиска. Профессор стремился как можно скорее закончить разработку генератора ходов и модуля оценки позиций. После этого он смог бы заняться так интересующим его модулем контроля поиска.

Размышляя над архитектурой специализированного шахматного чипа, Фэн Сюн Сю увидел возможность решения Проблемы Компьютерных Шахмат. Так в научных кругах называлась задача разработки программы или компьютера, способного обыграть действующего чемпиона мира по шахматам.

Фэн Сюн Сю выделил два этапа решения Проблемы Компьютерных Шахмат:

1. Создать шахматный компьютер, работающий на одном СБИС чипе или на небольшом количестве таких чипов.

2. Использовать большое количество шахматных чипов параллельно, чтобы значительно ускорить поиск.

После того как Берлинер отказался от идей Фэн Сюн Сю, аспирант решил разработать свой собственный шахматный компьютер независимо от команды HiTech. К 1986 году он спроектировал специализированный шахматный чип. Чип объединял генератор ходов и минимальную оценочную функцию. Эта функция оценивала позицию на основе таблицы расположения фигур. Такая таблица даёт оценку каждой фигуры в зависимости от занимаемого ею поля. 

Чип реализовывал генератор ходов аналогичный компьютеру Belle. Он применял эвристику "самая ценная жертва, наименее ценный агрессор" (MVV-LVA).

Возможностей чипа не хватало для полноценной игры в шахматы. Поэтому требовался компьютер общего назначения, который мог бы использовать результаты работы чипа для дальнейших рассчётов. Компьютер отвечал за поиск по шахматному дереву с помощью минимаксного алгоритма с альфа-бета отсечением. Также он дополнял оценку позиции такими факторами, как материал, пешечная структура, контроль полей, размещение и мобильность фигур.

Партию шахматных чипов изготовила компания [MOSIS](https://en.wikipedia.org/wiki/MOSIS). Она производит полупроводники и сотрудничает с американскими университетами. Изготовление чипов для учебных проектов финансировал [Национальный научный фонд США](https://ru.wikipedia.org/wiki/Национальный_научный_фонд) (National Science Foundation, NSF) и [управление перспективных исследовательских проектов Министерства обороны США](https://ru.wikipedia.org/wiki/Управление_перспективных_исследовательских_проектов_Министерства_обороны_США) (DARPA). Благодаря сотрудничеству университетов и MOSIS студенты получали возможность изготавливать свои чипы бесплатно.

Для тестирования чипов на брак производства Фэн Сюн Сю написал простую программу. Она проверяла базовые алгоритмы. Такого теста было недостаточно для проверки производительности. Сю хотел, чтобы полноценная шахматная программа запустилась на его чипе и сыграла несколько партий. Это позволило бы оценить скорость перебора позиций.

[Томас Анантараман](https://www.chessprogramming.org/Thomas_Anantharaman) учился на той же кафедре информатики, что Фэн Сюн Сю. У Анантарамана уже была готовая шахматная программа для компьютера общего назначения. Он написал её для развлечения и не имел планов на её развитие. Анантараман согласился помочь Сю с тестированием чипов. Он установил чипы в свой компьютер и адаптировал для них шахматную программу. В результате тестирования им удалось достичь скорости поиска около 30000 позиций в секунду. Такую производительность в 1986 году имели только специализированные шахматные компьютеры или шахматные программы, запущенные на суперкомпьютерах.

Следующим шагом в тестировании чипа стала идея его разгона. Для этого Фэн Сюн Сю решил собрать недорогую шахматную машину из списанного оборудования, которое нашлось на кафедре. Частью этого оборудования была рабочая станция [Perq](https://ru.wikipedia.org/wiki/PERQ).

В это время к проекту присоединился [Мюррей Кэмпбелл](https://www.chessprogramming.org/Murray_Campbell). Он был сильнейшим шахматистом среди аспирантов и помогал программировать оценочную функцию.

Чтобы протестировать шахматную машину, команда Фэн Сюн Сю зарегистрировалась на ежегодный чемпионат ACM. Сю отправил заявку в турнирный комитет, где назвал свою шахматную машину [ChipTest](https://en.wikipedia.org/wiki/ChipTest).

В чемпионате ACM 1986 года компьютер ChipTest просчитывал около 100000 позиций в секунду. Благодаря этому, он набрал 2.5 очка в пяти партиях: две победы, два поражения и одна ничья.

Уже на следующем чемпионате ACM 1987 года скорость поиска ChipTest достигла 400000 позиций в секунду. Это стало возможным благодаря новой рабочей станции, которая заменила устаревшую Perq.

Также в ходе подготовки к ACM 1987 года Томас Анантараман реализовал алгоритм **единственных продлений** ([singular extensions](https://www.chessprogramming.org/Singular_Extensions)). Идея этого алгоритма в увеличении глубины поиска, если оба игрока вынуждены выполнять последовательность **единственных хороших ходов**. Единственный хороший ход значительно лучше альтернатив. Это означает, что именно его выберет игрок, когда настанет очередь делать ход.

Другими улучшениями ChipTest к турниру были:

1. Добавление оценки пешечной структуры.

2. Исправление программных и аппаратных ошибок, которые привели к поражениям в партиях на турнире ACM 1986 года.

Благодаря всем улучшениям, сила игры ChipTest выросла примерно на 300 очков Эло. Это позволило шахматной машине занять первое место на турнире ACM 1987 года.

В 1987 году команду ChipTest пригласили на Открытый чемпионат Америки (American Open). В этом чемпионате участвовали и шахматные компьютеры и профессиональные шахматисты. Но разработчики отказались от участия из-за возражений команды HiTech. Оценочная функция ChipTest использовала некоторый программный код, который Кэмпбелл позаимствовал из HiTech. Это стало формальной причиной, почему компьютера ChipTest не было на турнире. Ещё одна неформальная причина была в том, что в это время Сю разрабатывал следующую версию шахматного чипа. Позже он стал известен под названием Deep Thought.

#### 3.4.3.2 Deep Thought

Успехи ChipTest показали, что Фэн Сюн Сю выбрал правильное направление для решения Проблемы Компьютерных Шахмат. Его следующей целью была победа на турнире Fredkin Masters Open 1988 года.

Фонд Фредкина спонсировал не только премию, но и серию ежегодных шахматных турниров. Турниры проходили на протяжении 1980-х годов. В 1988 году планировался заключительный турнир этой серии. На Fredkin Masters Open лучшие шахматные программы играли против профессиональных шахматистов-людей.

Команда ChipTest получила приглашение на Fredkin Masters Open благодаря победе на ACM 1987 года. Для участия в турнире Фэн Сюн Сю разработал новый шахматный компьютер. Его главным компонентом был специализированный шахматный чип, как и у ChipTest. Новый компьютер получил название Deep Thought в честь вымышленного суперкомпьютера из романа Дугласа Адамса «Автостопом по галактике».

Первая версия Deep Thought 0.01 была разработана в мае 1988 года. Она использовала один шахматный чип нового образца. В ноябре 1988 команда Фэн Сюн Сю смогла наладить работу двухпроцессорной версии шахматного компьютера. Он получил название Deep Thought 0.02. Эта версия могла просчитывать 720000 позиций в секунду — в два раза быстрее чем ChipTest.

У нового компьютера Deep Thought было несколько преимуществ над ChipTest. Прежде всего Deep Thought получил новую аппаратную и программную оценочную функцию. Его шахматные чипы распознавали многие динамические признаки позиции: пешечную структуру, проходные пешки, ладьи на открытых вертикалях и т.д. Эта аппаратная оценка работала на [программируемых пользователем вентильных матрицах](https://ru.wikipedia.org/wiki/Программируемая_пользователем_вентильная_матрица) (FPGA).

Динамические факторы позиции, обнаруженные на аппаратном уровне, использовались как примитивы для программной оценки позиции. Её выполняла рабочая станция, к которой подключались оба чипа Deep Thought 0.02.

Мюррей Кэмпбелл написал программу для [автоматической настройки](https://www.tim-mann.org/deepthought.html) оценочной функции. Она рассчитывала важность тех или иных факторов позиции на основе базы данных из 868 игр между гроссмейстерами. В результате автоматической настройки Deep Thought предпочитал те же ходы, что и гроссмейстеры в изученных им партиях. 

Одним из слабых мест ChipTest было отсутствие дебютной книги. Майк Браун был одногруппником Фэн Сюн Сю. Он согласился написать программу для просмотра всех доступных дебютных вариантов. Эта программа искала известные ловушки и новинки. Благодаря этой работе, Deep Thought получил более сильную игру в дебюте.

В результате всех улучшений Deep Thought 0.01 разделил второе место с двумя мастерами в турнире Fredkin Masters Open. Он набрал 4,5 очка из 6-ти возможных. Его турнирный рейтинг составил 2599 пунктов Эло. ChipTest занял пятое место, набрав 4 очка из 6. Ему присвоили рейтинг 2521 пунктов Эло.

[Открытый чемпионат США по шахматам](https://ru.wikipedia.org/wiki/Открытый_чемпионат_США_по_шахматам) (The U.S. Open Championship) 1988 года в Бостоне стал первым турниром, в котором участвовала версия Deep Though 0.02 с двумя шахматными чипами. После первых трёх партий команда Фэн Сюн Сю обнаружила программные ошибки в коде для поддержки двух чипов. Поэтому остальные партии турнира играла программа Deep Though 0.01, запущенная на компьютере Deep Though 0.02. Она использовала только один шахматный чип. В результате турнира компьютер набрал 7 очков из 10 возможных. Его рейтинг снизился с 2599 до 2495 пунктов Эло.

Открытый чемпионат США стал хорошей проверкой для Deep Though 0.02. Команда разработчиков потратила два месяца на исправление обнаруженных программных ошибок.

Исправленная версия Deep Though 0.02 выиграла турнир ACM 1988 года в Орландо, штат Флорида. На этом турнире Deep Though впервые публично сыграл с HiTech и одержал победу.

В ноябре 1988 год Deep Thought участвовал в турнире Software Toolworks. Это был один из крупнейших турниров в Америке в том году. Кроме американских шахматистов на него были приглашены бывший чемпион мира [Михаил Таль](https://ru.wikipedia.org/wiki/Таль,_Михаил_Нехемьевич), [Бент Ларсен](https://ru.wikipedia.org/wiki/Ларсен,_Бент) и [Самуэль Решевский](https://ru.wikipedia.org/wiki/Решевский,_Самуэль), которые ранее участвовали в отборочных соревнованиях к матчу за звание чемпиона мира. На момент турнира Таль занимал 16-е место в мировом рейтинге, а Ларсен — 42-е.

Именно на турнире Software Toolworks Deep Thought стал первым компьютером, который смог обыграть гроссмейстера в партии с классическим контролем времени. Это была партия с Бентом Ларсеном. Победителями турнира стали гроссмейстер Энтони Майлс и Deep Thought.

В мае 1989 Deep Though занял первое место на 6-ом чемпионате мира среди компьютерных программ (WCCC), который проводился в Эдмонтоне, Канада. Компьютер не проиграл ни одной из 5-ти партий.

Благодаря этим успехом, команда Deep Though получила промежуточную премию Фредкина в размере 10000$. Их компьютер официально достиг уровня игры интернационального мастера.

{caption: "Иллюстрация 3-4. Команда Deep Thought в 1988 году: Мюррей Кемпбелл, Фэн Сюн Сю, Томас Анантараман, Майкл Браун, Андреас Новатчук"}
![Команда Deep Thought](images/Chess/deep-thought-team.jpg)

В октябре 1989 года состоялся матч из двух игр между Deep Thought и действующим чемпионом мира Гарри Каспаровым. Команда Фэн Сюн Сю продолжала совершенствовать шахматный компьютер. К 1989 году он состоял из трёх [печатных плат](https://ru.wikipedia.org/wiki/Печатная_плата), на каждой из которых было установлено по два шахматных чипа. Каждой платой управляла отдельная рабочая станция. Все станции соединялись через локальную сеть и вели параллельный поиск. Эта версия Deep Though была в три раза быстрее, чем победившая в турнире WCCC версия 0.02.

Каспаров легко одолел компьютер в обеих партиях. Этот матч продемонстрировал недостатки шахматных компьютеров того времени:

1. Жадность к материалу. Компьютеры охотно разменивали позиционное преимущество на материал. Кроме того они всеми силами пытались избежать потери фигур. Это часто приводило к плохим позициям.

2. Отсутствие позиционной игры. Если не было очевидно хороших ходов, компьютер не развивал свою позицию, а терял время совершая бессмысленные ходы.

Каспаров умело воспользовался этими недостатками. [В первой партии](https://lichess.org/j0Vfex0w#1) он последовательно наращивал позиционное преимущество. Когда оно стало значительным, шахматист преобразовал его в материальное и поставил мат Deep Thought.

[Во второй партии](https://lichess.org/1l9BGxUL#73) Каспаров пожертвовал коня, благодаря чему смог провести сильную атаку на короля. В результате этой атаки он получил материальное преимущество, достаточное для победы. Deep Thought не смог правильно оценить последствий этой жертвы. Она дала Каспарову позиционное преимущество, которое он реализовал только через несколько ходов. Компьютер был не способен просчитать ходы на такую глубину и поэтому не увидел опасности.

Позднее в своей книге "Behind Deep Blue" Фэн Сюн Сю утверждал, что в этом матче у Deep Though была программная ошибка. Из-за неё компьютер откладывал рокировку короля и вместо неё совершал ходы, не имевшие особого смысла. Это привело к потере инициативы в обеих партиях против Каспарова. Получив такое преимущество в развитии фигур, чемпион мира легко одолевал Deep Thought.

Матч Deep Though с Каспаровым дал команде Фэн Сюн Сю важную информацию. Разработчики компьютера смогли оценить важность домашней подготовки. Перед началом игры Каспаров получил распечатки всех публичных игр Deep Though. Он подготовился к дебютам, которые обычно разыгрывал компьютер. Именно хорошая контригра в дебюте за белых привела к лёгкой победе Каспарова во второй игре.

#### 3.4.3.3 Deep Thought II

В 1988 году до менеджеров IBM дошли слухи об успехах Deep Thought. Мюррей Кемпбелл, Фэн Сюн Сю и Томас Анантараман по отдельности прошли собеседования в исследовательском центре IBM. В итоге им предложили постоянные должности в компании.

В 1989 году команда Фэн Сюн Сю приступила к работе в IBM. В отличие от других проектов компании разработчикам Deep Thought предоставили полную свободу. Назначенный IBM менеджер выполнял скорее вспомогательную роль. Он не контролировал работу команды и не диктовал технические решения.

Спустя некоторое время Томас Анантараман покинул команду. Он отвечал за написание программ. Его место занял штатный программист исследовательского центра IBM [Артур Джозеф Хоэн](https://www.chessprogramming.org/Joe_Hoane).

После того как команда окончательно сформировалась, началось обсуждение планов. Было решено разработать улучшенную версию Deep Thought под названием Deep Thought II. Позднее в прессе этот компьютер станет известным как "прототип Deep Blue".

Для создания Deep Thought II было несколько технических причин. Вот наиболее важные из них:

1. Использовать его как прототип для изучения алгоритмов параллельного поиска. Планировалось увеличить число шахматных чипов в Deep Thought II до 24-х.

2. Переписать программу для рабочей станции, которая управляла шахматными чипами. Цель заключалась в улучшении алгоритма единственных продлений.

3. Улучшить шахматные знания, заложенные в компьютер. Прежде всего это касалось дебютной книги.

Главной же причиной была политическая. Руководство IBM настаивало на регулярном участии команды Фэн Сюн Сю в соревнованиях по компьютерным шахматам. Это было важно для сохранения престижа и освещения успехов IBM в прессе. Шахматные компьютеры конкурентов уже догоняли Deep Thought по силе игры. Чтобы сохранять разрыв с ними, нужен был новый компьютер. Это позволило бы выиграть время, пока Фэн Сюн Сю разрабатывал новый компьютерный чип для игры против Каспарова. Deep Thought II выполнил эту задачу и доминировал среди шахматных компьютеров с 1991 по 1995 года.

Deep Thought II получил переписанную с нуля программу, новую дебютную книгу и дополнительные шахматные чипы. Благодаря ускорению поиска в 5-8 раз и усовершенствованному алгоритму единственных продлений, Deep Thought II без затруднений обыгрывал Deep Thought в тестовых партиях.

Первым публичным мероприятием Deep Thought II стал турнир ACM в ноябре 1991 года в Альбукерке, штат Нью-Мексико. Компьютер одержал победу во всех сыгранных им партиях. Самой сложный была игра против программы [Cray Blitz](https://www.chessprogramming.org/Cray_Blitz), которая работала на шахматном суперкомпьютере [Cray C90](https://www.chessprogramming.org/Cray_X-MP#C90). Эта программа считалась одной из самых быстрых среди участников турнира. Однако, Deep Thought II пересчитал Cray Blitz с большим запасом.

В феврале 1993 года IPB Дании организовал матч Deep Thought II против датских шахматистов. Матч состоял из восьми игр: четыре против Бента Ларсена и четыре против команды других гроссмейстеров. Результаты игр были такими: Ларсен 2,5 — Deep Thought II 1,5; Deep Thought II 3 — сборная Дании 1. В некоторых партиях стали очевидны пробелы в шахматных знаниях компьютера. Наиболее критичные из них — это ошибки в оценке шахматных окончаний и слабая дебютная подготовка. После завершения матча команда разработчиков занялась исправлением обнаруженных проблем.

В последний раз Deep Thought II выступил на чемпионате мира по шахматам среди компьютерных программ WCC в мае 1995 года в Гонконге. Организаторы обратились к IBM с просьбой спонсировать турнир. Менеджер команды Фэн Сюн Сю увидел в этом турнире возможность хорошей рекламой для предстоящего матча с Каспаровым. Он настоял на спонсировании мероприятия и участии в нём Deep Thought II.

Из пяти партий Deep Thought II выиграл три. Партия с программой [WChess](https://www.chessprogramming.org/WChess) закончилась ничьей. В последнем туре Deep Thought II проиграл программе [Fritz](https://www.chessprogramming.org/Fritz), которая работала на обычном персональном компьютере. Эта программа заняла первое место в турнире, набрав в сумме четыре очка.

Турнир WCC показал насколько важно иметь резервную линию связи или механизм переподключения к шахматному компьютеру. Во время турнира Deep Thought II находился в Америке. Линия связи с Гонконгом работала с перебоями. Из-за разрыва соединения Deep Thought II пришлось перезапускать во время последней партии против Fritz. Это привело к тому, что шахматный компьютер потерял время при анализе позиции. Ему пришлось начинать анализ с нуля и он выбрал худший ход, чем тот который нашел до перезагрузки. Это стало одной из причин поражения Deep Thought II.

#### 3.4.3.4 Версия Deep Blue 1996 года

После перехода команды Фэн Сюн Сю в IBM встал вопрос о наименовании нового суперкомпьютера. У широкой публики имя Deep Thought вызывало ассоциации с фильмом для взрослых "Deep Throat". Коллеги и репортеры в шутку часто путали эти названия.

Сотрудникам IBM был объявлен конкурс на новое имя для шахматного компьютера. Среди предложенных вариантов победил Deep Blue. Это сочетание имени проекта Deep Thought и неофициального прозвища IBM — Big Blue (голубой гигант).

После ухода из проекта Томаса Анантарамана Фэн Сюн Сю пришлось самому переписать программу для рабочей станции, которая управляла шахматными чипами. Эта работа дала Фэн Сюн Сю полезный опыт и идеи для улучшения шахматного чипа. Такие улучшения позволили бы программе управлять чипом более эффективно. Они были реализованы в новом чипе для Deep Blue.

Производством чипов для Deep Blue занималась компания VLSI Technology. Инструменты для проектирования чипов, которые предлагала компания не позволяли добиться нужной плотности упаковки транзисторов на кристалле. Поэтому Фэн Сюн Сю пришлось компоновать их вручную для компонента чипа, который выполнял функцию детектора повторений позиций на доске. Эта работа затянулась. В результате команда решила отказаться от детектора повторений из-за нехватки времени. Это значительно ослабило шахматный компьютер Deep Blue.

В конце 1994 прошли переговоры о проведении матча между Гарри Каспаровым, IBM и ACM. В результате участники договорились о проведении матча в феврале 1996 года. Эта дата совпала с празднованием 50-летия ACM.

Первой публичной игрой Deep Blue стал товарищеский матч против чемпиона мира по шахматам среди женщин — Се Цзюнь. Матч проводился в честь открытия новой исследовательской лаборатории IBM в Пекине 21 сентября 1995 года. Команда Фэн Сюн Сю рассматривала этот матч как проверку Deep Blue перед игрой с Гарри Каспаровым.

В начале сентября VLSI Technology поставила в IBM первые шахматные чипы Deep Blue. Базовые тесты Фэн Сюн Сю обнаружили проблему с подключением чипов к плате на рабочей станции. Для подключения использовалась 32-битная [MCA шина](https://ru.wikipedia.org/wiki/Micro_Channel_Architecture) (Micro Channel Architecture), разработанная IBM. Ошибку удалось решить, изменив порядок интерпретации байтов в управляющей программе.

Другая проблема была связана с наводками в проводниках шины MCA на чипе. При переключении одного контакта шины с 1 на 0, на соседних контактах иногда падало напряжение из-за перекрёстной связи. Проблема возникла из-за более плотной упаковке проводников на чипе, чем это было в версии кристалла для Deep Thought. В качестве временного решения Фэн Сюн Сю добавил чтение 32-битного значения ноль из чипа перед чтением реальных значений. Благодаря этому изменению, чип прошел все базовые тесты.

Следующий этап тестирования чипа проводил Джо Хоэн. Он обнаружил, что чип ведёт себя некорректно в некоторых позициях, когда чёрные могли [взять пешку на проходе](https://ru.wikipedia.org/wiki/Взятие_на_проходе). Отладка показала, что в проектировании логики чипа была допущена ошибка. Временным решением стало использование двух шахматных чипов параллельно. Первый рассматривал доску с нормальной позицией, а второй — доску перевёрнутую на 180 градусов. При таком повороте белые фигуры становились чёрными и ошибка не воспроизводилась. Далее управляющая программа сравнивала результаты обоих чипов и исправляла ошибку.

Фэн Сюн Сю отправил отчёт об обнаруженных проблемах в VLSI Technology. Компания успела выпустить исправленную партию чипов к матчу с Каспаровым в феврале 1996 года.

Все временные исправления значительно усложнили управляющую программу. У Джо Хоэна оставалось очень мало времени, чтобы запрограммировать эти исправления перед матчем с Се Цзюнь. В результате во время игры программа работала нестабильно и несколько раз завершалась с ошибкой.

В первой партии Се Цзюнь сыграла новинку в дебюте. После окончания дебюта Deep Blue дал низкую оценку своей позиции. Затем на доске возникла позиция, когда чёрные могли взять пешку на проходе. Это привело к падению программы. Партию пришлось переигрывать с самого начала. В той же позиции снова случился сбой программы. В результате Фэн Сюн Сю решил сдаться.

Во второй партии матча программа работала стабильнее. Благодаря сильной тактической игре, Deep Blue получил хорошую позицию и Се Цзюнь сдалась.

Товарищеский матч с Се Цзюнь проходил с укороченным контролем времени. Для полноценной проверки Deep Blue команда разработчиков решила провести матчи с классическим контролем времени против трёх сильнейших гроссмейстеров США. В этих матчах играла версия компьютера Deep Blue Junior. Она работала с гораздо меньшим числом шахматных чипов, чем финальная версия Deep Blue.

Матчи состояли из двух партий. Deep Blue Junior выиграл один матч со счётом 2-0, свёл другой в ничью (1-1) и один проиграл (0-2). Обыграть компьютер в двух партиях смог шахматист [Джоэл Бенджамин](https://en.wikipedia.org/wiki/Joel_Benjamin). В результате его пригласили на должность консультанта в команду Deep Blue. Обязанностями Джоэла были дебютная подготовка компьютера, улучшение оценочной функции и тестирование результатов.

В декабре 1995 года компания VLSI Technology прислала небольшую партию исправленных шахматных чипов. Её хватило, чтобы оснастить Deep Blue Junior. Именно на нём Джоэл Бенджамин проделал всю дебютную подготовку к матчу с Каспаровым.

Вторая партия исправленных чипов пришла за две недели до матча. Поэтому сборка и тестирование финальной версии Deep Blue проходила в большой спешке.

Ресурсы рабочей станции позволяли подключить к ней 576 шахматных чипов. Однако, VLSI Technology не успела произвести достаточное их количество из-за ошибок, допущенных при проектировании. В результате на Deep Blue было установлено только 216 чипов. Каждый из них просматривал около 1,6 миллиона позиций в секунду. Теоретическая скорость поиска компьютера должна была достигать 300 миллионов позиций в секунду. Однако, реальная наблюдаемая скорость работы во время матча составляла около 100 миллионов позиций в секунду. Причина этого заключалась в издержках программного обеспечения при параллельном поиске.

Оценочная функция складывалась из набора факторов. Большая их часть вычислялась каждым шахматным чипом самостоятельно. Лишь некоторые факторы для наиболее перспективных позиций рассчитывались управляющей программой на рабочей станции. Благодаря высокой специализации чипов, каждый из них выполнял шахматные расчёты со скоростью универсального суперкомпьютера стоимостью несколько миллионов долларов. На 1996 год Deep Blue был самым мощным шахматным компьютером из когда-либо созданных.

Первый матч между Deep Blue и Гарри Каспаровым прошел с 10 по 17 февраля 1996 года в городе Филадельфия. Deep Blue играл удалённо из Нью-Йорской исследовательской лаборатории IBM.

В [первой партии](https://lichess.org/study/QnD0xjJc) Deep Blue играл белыми. На стандартный ход компьютера e2-e4 Каспаров сыграл [сицилианскую защиту](https://ru.wikipedia.org/wiki/Сицилианская_защита). Этот агрессивный дебют был одним из любимых у чемпиона мира. Он навязывал белым активную игру и тактически сложные острые позиции.

Активное начало позволило Deep Blue сыграть в полную силу. Он показал насколько сильную тактическую игру даёт его огромная вычислительная мощность.

Компьютер отыграл по дебютной книге до 10-ого хода. Затем на 13-ом ходу он напал на ферзя  противника Nb5 (см. иллюстрацию 3-5). Одним из вариантов ответа для Гарри Каспарова было уйти в глухую оборону. Но вместо этого он выбрал атаку на короля противника, чтобы не дать Deep Blue бесплатное преимущество в позиции.

{caption: "Иллюстрация 3-5. Deep Blue атакует ферзя Гарри Каспарова Nb5 на 13-ом ходу 1-ой партии"}
![13-ый ход в 1-ой партии](images/Chess/kasparov-vs-db-1996-1st-game.png)

Оборняясь от атаки Каспарова, Deep Blue успел при этом взять все незащищённые пешки на ферзевом фланге чёрных. Рассчёт компьютера показывал: его фигуры успеют контратаковать ровно за один ход до того, как Каспаров поставит мат. Именно это и произошло. В результате атака чемпиона мира захлебнуась и ему пришлось сдаться из-за материального перевеса компьютера в две пешки и безнадёжной позиции.

Победа Deep Blue в первой партии вызвала сенсацию и привлекла внимание широкой публики к матчу. Посвященный матчу веб-сайт IBM стал недоступен из-за наплыва пользователей. Газета "USA Today" посвятила матчу статью на первой странице.

Играя за белых, во [второй партии](https://lichess.org/study/QnD0xjJc) Гарри Каспаров учёл свои ошибки. Он имел большой опыт игры против шахматных компьютеров и знал их слабости. Одна из них — неспособность строить долгосрочные стратегические планы. Именно на этой слабости и сконцентрировался  Каспаров. Он применил медленный маневренный дебют за белых, который привел к открытому [Каталонскому началу](https://ru.wikipedia.org/wiki/Каталонское_начало). Затем на 14-м ходу чемпион сыграл новинку Nc6 (см. иллюстрацию 3-6).

{caption: "Иллюстрация 3-6. Новинка от Гарри Каспарова Nc6 на 14-ом ходу 2-ой партии"}
![14-ый ход во 2-ой партии](images/Chess/kasparov-vs-db-1996-2nd-game.png)

Идея Гарри Каспарова была в том, чтобы не создавать очевидных мишеней для атаки со стороны Deep Blue. Сам же чемпион провёл атаку манёвренными фигурами — конями и ферзём. В результате компьютер получил слабую пешечную структуру, которую было сложно защищать. Такое преимущество в позиции уже гарантировало для белых ничью.

Далее Каспаров обратил внимание на предпочтения Deep Blue, запрограммированные в его оценочной функции. Одно из них — избегать размена ферзей. Команда разработчиков полагала, что такое решение увеличит тактические возможности компьютера. Но Каспаров использовал эту особенность в своих целях. Он неоднократно ставил компьютер перед выбором: размен ферзей или вынужденный более слабый ход.

После длинного и тонкого маневра в эндшпиле Гарри Каспаров выиграл две пешки. Этого перевеса в материале было достаточно для победы. В результате Мюррей, выполнявший роль оператора во второй партии, сдался на 73-м ходу.

После второй партии был день отдыха. Мюррей и Джоэл посвятили его работе над дебютной книгой Deep Blue. Фэн Сюн Сю занимался тестированием программы и устранением обнаруженных проблем с оценочной функцией. Джо Хоэн улучшал программу для оптимизации параллельной работы всех шахматных чипов.

В [третьей партиии](https://lichess.org/study/QnD0xjJc) Deep Blue разыграл тот же дебют, что и в первой игре матча. Но в этом дебюте компьютер сделал новый ход, который добавил накануне Джоэл Бенджамин. Он открывал возможности для атаки на короля противника. Гарри Каспаров предвидел эту атаку и подготовился к ней. В результате Deep Blue отказался от заложенного в дебютной книге 18-ого хода Be5 и сходил Rc1 (см. иллюстрацию 3.7).

{caption: "Иллюстрация 3-7. Deep Blue делает 18-ый ход Rc1 вместо Be5 из дебютной книги в 3-ей партии"}
![18-ый ход в 3-ей партии](images/Chess/kasparov-vs-db-1996-3rd-game.png)

Планируемый ход Be5 приводил к потере фигуры в сложившейся на доске позиции. Изменение плана компьютером дало Гарри Каспарову преимущество в позиции: у Deep Blue оказались две изолированные пешки в центре. Каспаров попытался провести на них атаку. В ответ на неё компьютер нашёл длинную цепочку хороших ходов. Это позволило разменять большинство фигур. У каждой стороны осталось по ладье и четыре пешки. Позиция оказалась равной и стороны согласились на ничью.

В [четвёртой партиии](https://lichess.org/study/QnD0xjJc) Гарри Каспаров играл белыми. Deep Blue разыграл [славянскую защиту](https://ru.wikipedia.org/wiki/Славянская_защита). Это один из дебютов, который Бенджамин и Мюррей подготовили для второй партии. Но из-за ошибки при загрузке файла компьютер не смог сыграть его раньше. В результате после выхода из дебюта Deep Blue получил позицию, которая по его оценке была неблагоприятной.

На 22-ходу Гарри Каспаров планировал пожертвовать коня за две пешки и возможность атаки (см. иллюстрацию 3-8). Когда компьютер должен был ответить, произошёл сбой в программе. В результате Deep Blue пришлось перезагружать. Когда он вернулся к работе, то сыграл B×c4 вместо ожидаемого Каспаровым взятия B×f5. Этот ход привел к серии разменов, в результате которых стороны сравнялись по материалу. При этом Deep Blue оценивал свою позицию немного хуже.

{caption: "Иллюстрация 3-8. Гарри Каспаров начинает атаку на королевский фланг Deep Blue: 22-ой ход в 4-ой партии"}
![22-ой ход в 4-ой партии](images/Chess/kasparov-vs-db-1996-4th-game.png)

Далее последовала серия маневров, в результате которых стороны разменялись двумя пешками на ферзевом фланге. Затем на 42-ом ходу Гарри пожертвовал ладью за сильного коня Deep Blue. Спустя несколько ходов, ему удалось создать ничейную позицию и партия закончилась.

Следующий день — 15 февраля был днём отдыха. В матче сохранялся равный счёт 2-2. Команда Deep Blue снова сконцентировалась на работе над дебютной книгой. Джоэл и Мюррей искали вариант, который мог бы принести победу за белых. Они ожидали, что Каспаров снова сыграет сицилианскую защиту за чёрных.

В [пятой партиии](https://lichess.org/study/QnD0xjJc) Каспаров, вопреки ожиданиям команды Deep Blue, сыграл [русскую партию](https://ru.wikipedia.org/wiki/Русская_партия). Она также известна как защита Петрова. Это означало, что все дебютные наработки Бенджамина, сделанные в ходе матча, оказались невостребованы. Компьютер отыгрывал по дебютным вариантам двухмесячной давности. Он перевёл позицию в [дебют четырёх коней](https://ru.wikipedia.org/wiki/Дебют_четырёх_коней).

И защита Петрова, и дебют четырёх коней относятся к спокойным началам. Для них характерны массовые размены фигур и симметричные пешечные структуры. Гарри Каспаров выбрал такой дебют из-за того, что не успел как следует отдохнуть между партиями. Он не был готов к острой тактической схватки с компьютером. Именно в такой спокойной игре начали обнаруживаться слабости оценочной функции Deep Blue.

После серии разменов в дебюте Гарри Каспаров получил небольшое преимущество в позиции на 23-ем ходу. Иллюстрация 3-9 демонстрирует позицию на доске в этот момент.

{caption: "Иллюстрация 3-9. Позиция на доске в 5-ой игре, когда Каспаров предложил ничью"}
![23-ий ход в 5-ой партии](images/Chess/kasparov-vs-db-1996-5th-game.png)

После этого хода чемпион мира предложил ничью. Он хотел сохранить силы для следующей игры белыми на победу. После совещания с командой Фен Сюн Сю принял решение продолжить игру. Это решение стало переломным моментом в матче.

Уже следующим ходом Qc3 Deep Blue совершил ошибку, связав своего ферзя и коня. Гарри Каспаров тем временем начал продвигать вперёд свои пешки. Компьютер не понимал слабости своей позиции и не видел хорошего продолжения. Он сделал несколько бессмысленных ходов ферзём и ладьёй, пока Каспаров концентрировал свои силы для поддержки проходной пешки на вертикале e. Пешку удалось провести и в результате размена Каспаров выиграл материал. Этого оказалось достаточно для победы.

Пятая партия дала Гарри Каспарову важную информацию о слабых сторонах Deep Blue. Все они сводились к ошибкам оценочной функции. Чемпион почувствовал уверенность в своих силах и хорошо продумал свою стратегию для шестой партии.

Для [шестой партии](https://lichess.org/study/QnD0xjJc) Мюррей и Джоэл постарались подготовить дебютный вариант, который дал бы возможность сыграть на победу за чёрных. Они остановились на одном из уже хорошо проработанных вариантов в дебютной книге Deep Blue — славянской защите.

Играя за белых, Гарри Каспаров намеренно изменил порядок ходов в начале партии. Тем самым он вывел Deep Blue из его дебютной книге. Компьютер в отличие от человека не понимал, что в определённых дебютах фигуры должны встать на определённые поля. Последовательность ходов при этом не важна. Глубокий поиск не мог помочь Deep Blue в начале партии. В результате он сделал ряд слабых ходов и получил пассивную позицию.

Гарри Каспаров последовательно продвигал пешки на ферзевом фланге. В итоге фигуры Deep Blue оказались зажаты и только мешали друг дуруг. Последнюю серьёзную ошибку компьютер совершил на 30-м ходу, когда заблокировал свою ладью слоном. Иллюстрация 3-10 демонстрирует этот ход.

{caption: "Иллюстрация 3-10. Последняя серьёзная ошибка Deep Blue в 6-ой партии: 30-ый ход Bb8"}
![30-ый ход в 6-ой партии](images/Chess/kasparov-vs-db-1996-6th-game.png)

Дальше последовал размен фигур. В результате чёрные получили положение под названием [цугцванг](https://ru.wikipedia.org/wiki/Цугцванг). В такой позиции любой ход ведёт к потере материала или мату. Тогда команда Deep Blue приняла решение сдаться. Гарри Каспаров одержал уверенную победу в матче со счётом 4-2.

В первых четырёх партиях Deep Blue удалось отыграть заранее подготовленные дебюты. Это предотвратило очевидные позиционные ошибки с его стороны. Но в двух последних партиях Гарри Каспаров сумел вывести компьютер из хорошо проработанных дебютных вариантов. Чемпион нащупал недостатки в игре оппонента и умело их использовал. У команды Deep Blue не было достаточно времени исправить эти очевидные недочёты.

#### 3.4.3.5 Версия Deep Blue 1997 года

Матч между Deep Blue I и Каспаровым дал команде IBM информацию о слабых сторонах компьютера. Фэн Сюн Сю и его коллеги были настроены оптимистично. Они видели пути улучшения игры Deep Blue.

Прежде всего матч с Каспаровым показал, что производительности шахматного микропроцессора достаточно для игры на высшем уровне. Проблема компьютера была в недостатке общих шахматных знаний. Это приводило к слабой стратегии и непониманию тонкостей разных позиций. Чемпион мира одержал победу именно благодаря лучшей стратегической игре, а не тактической.

Вторая проблема была в недостатке времени для качественной разработки управляющей программы. Команда Deep Blue не успела до матча с Гарри Каспаровым изучить и найти применение  всем аппаратным признакам оценки, которые Фэн Сюн Сю заложил в чип при его проектировании. По мнению команды именно такое улучшение оценочной функции должно было значительно усилить игру компьютера.

Третья проблема была в том, что команда впервые играла такой крупный матч на протяжении нескольких дней. Это имело несколько поседствий. Во-первых, когда Гарри Каспаров предложил ничью в пятой партии, команда потратила слишком много игрового времени на обсуждение принимать её или нет. Во-вторых, не было удобных инструментов, чтобы устранять обнаруженные проблемы и быстро вносить изменения в работу Deep Blue в ходе самого матча. Гарри Каспаров адаптировался к игре своего оппонента, а Deep Blue не имел такой возможности.

Следующим вопросом стало обсуждение — нужен ли Deep Blue новый шахматный чип? На этом настаивал Фэн Сюн Сю. В течении матча с Гарри Каспаровым компьютер делал бессмысленные ходы. Их причина: отсутсивие детектора повтоений на аппаратном уровне. Детектор повторений был только в программной части поиска. Он проверял позиции на очень ограниченной глубине дерева поиска. В результате когда позиция, которая нравилась Deep Blue, оказывалась "за горизонтом" детектора повторений, компьютер охотно её повторял.

Кроме аппаратного детектора повторений новый шахматный получил полностью переработанную оценочную функцию. Она стала намного более разносторонней и учитывала больше факторов позиции, чем прошлая версия. Ещё одним улучшением шахматного чипа стал новый генератор ходов. Он отсекал заведомо плохие шахматные ходы. Это значительно увеличило аппаратную скорость поиска.

Тем временем Мюррей Кэмпбелл использовал программный прототип новой оценочной функции и добавил к нему графический интерфейс. Таким образом у команды появился мощный инструмент для анализа шахматных позиций. Именно этот инструмент помог Джоэлу Бенджамину обнаружить проблему Deep Blue с контролем вертикальных линий. Компьютер правильно оценивал важность открытых вертикалей (без блокирующи хпешек) и старался контролировать их своими ладьями. Но он не понимал важность закрытых вертикалей, которые можно было позднее вскрыть ходом своей пешки. Эта ошибка во многом повлияла на поражение в шестой партии с Гарри Каспаровым. Deep Blue неправильно обращался со своими слонами на закрытых диагоналях.

>>>

Разработчики Deep Blue сделали основной упор на тестирование оценочной функции. Этой задачей занимался Джоэль Бенджамин. Он играл с программой Deep Blue, адаптированной для персонального компьютера. Программа называлась Deep Blue Junior. Её было проще запускать и изменять, чем версию для суперкомпьютера.

Бенджамин обнаружил несколько проблем в игре Deep Blue Junior. Программа недооценивала важность контроля за вертикальными линиями. Кроме того она неправильно боролась за этот контроль. Те же самые ошибки Deep Blue Junior совершал, когда надо было бороться за диагонали с помощью слонов.

Другая проблема Deep Blue Junior была в переоценке безопасности короля. Программа предпочитала защищать короля другими фигурами в течении всей партии. Бенджамин предложил менять важность такой защиты в зависимости от стадии игры и позиции. В дебюте и миттельшпиле программа всё так же уделяла внимание защите короля. Но в эндшпиле её поведение изменили. Теперь Deep Blue Junior предпочитал активно использовать короля в конце партии наравне с другими фигурами.

Для финального тестирования суперкомпьютера IBM пригласила известного шахматиста Мигеля Ильескаса. Он играл на турнирах того же уровня, что и Каспаров. По результатам игр Ильескас указал на проблемы в оценочной функции Deep Blue.

В команду шахматистов, которые работали с Deep Blue входили и другие гроссмейстеры: Ник де Фирмиан, Джон Федорович, Ларри Кристиансен, Майкл Роде. Они помогали Бенджамину подготавливать дебютную книгу для компьютера. По ней Deep Blue отыгрывал стандартные дебюты.

Параллельно с работой над оценочной функцией Deep Blue Фэн Сюн Сю работает над совершенствованием шахматного микропроцессора. В его конструкцию внесли значительные изменения. Это позволило увеличить его производительность. В результате новая версия компьютера Deep Blue II перебирала в два раза больше позиций в секунду (около 200 млн), чем предыдущая.

[Второй матч между Каспаровом и усовершенствованным Deep Blue II](https://habr.com/ru/post/390713/) состоялся в мае 1997 года. Так же как и первый матч, он состоял из шести партий. Каспаров уверенно выиграл первую партию, благодаря сильной игре. Во второй партии шахматист допустил стратегическую ошибку и проиграл. В следующих трёх партиях результатом была ничья.

В решающей шестой партии Deep Blue сделал нетипичный для компьютеров ход: пожертвовал коня в дебюте. На самом деле Deep Blue взял этот ход из дебютной книги, а не пришел к нему сам в результате анализа позиции. Каспаров оказался не готов к такому ходу и совершил ошибку. В итоге он проиграл партию и матч со счётом 3½:2½.

После матча Каспаров высказал претензии к IBM. Он утверждал, что игра была нечестная и некоторые ходы за Deep Blue делал гроссмейстер. Причина подозрений была в том, что игра компьютера была неровной. Иногда после плохого хода, Deep Blue делал очень хороший и наоборот.

IBM представила распечатки log-файлов. Из них стало понятно, что все ходы Deep Blue делал самостоятельно. Неровная игра компьютера объясняется **эффектом горизонта** ([horizon effect](https://www.chessprogramming.org/Horizon_Effect)). Deep Blue рассчитывал позицию, например, на 7 ходов вперёд. Однако, на 8 ходу у оппонента есть сильный ответный ход, который сводит на нет всю комбинацию. После первого хода в комбинации Deep Blue обнаруживает сильный ответ противника. В этом случае компьютер меняет свой план. Тогда уже сделанный ход оказывается слабым или даже ошибкой.

Каспаров настаивал на матче-реванше, но IBM отклонила это предложение. После победы Deep Blue над чемпионом мира цена на акции компании взлетела. Это был отличный маркетинговый ход, который подкрепил репутацию IBM среди инвесторов и принёс большую прибыль. Однако, сыгранные партии показали опытным шахматистам, что Deep Blue II играет не сильнее чемпиона мира. Поэтому результат матча-реванша мог оказаться любым. Поражение Deep Blue могло свести на нет все маркетинговые успехи IBM. Компания решила отказаться от такого риска.